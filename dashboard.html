<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instructor Dashboard</title>

  <!-- Styles -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:500,700&display=swap&subset=latin-ext" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600&display=swap&subset=latin-ext" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet">
  <link href="css/bootstrap.css" rel="stylesheet">
  <link href="css/fontawesome-all.css" rel="stylesheet">
  <link href="css/swiper.css" rel="stylesheet">
  <link href="css/magnific-popup.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">

  <!-- Favicon  -->
  <link rel="icon" href="images/NuevoFavicon.png">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 4.5rem 0 0;
      color: #333;
    }

    /* Navbar styles */
    .navbar-custom {
      background-color: #113448 !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .profile-nav-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-left: 1rem;
    }

    .profile-pic-nav {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #20bcba;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .profile-pic-nav:hover {
      transform: scale(1.1);
    }

    .profile-dropdown {
      position: relative;
      display: inline-block;
    }

    .profile-dropdown-content {
      position: fixed;
      right: 1rem;
      top: 60px;
      background-color: white;
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
      transition-delay: 0s;
    }

    /* Desktop: position relative to parent */
    @media (min-width: 992px) {
      .profile-dropdown-content {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.25rem;
      }
    }

    .profile-dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background 0.2s;
    }

    .profile-dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .profile-dropdown:hover .profile-dropdown-content {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      transition-delay: 0s;
    }

    .profile-dropdown-content:hover {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* Mobile support - show dropdown when clicked */
    .profile-dropdown-content.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .profile-dropdown-content a.messages-link i {
      transition: color 0.2s;
    }

    .profile-dropdown-content a.messages-link.has-unread i {
      color: #dc3545;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Notification badge on profile picture */
    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background-color: #dc3545;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      border: 2px solid white;
      animation: badgePulse 2s infinite;
    }

    .notification-badge.show {
      display: flex;
    }

    @keyframes badgePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Unread count badge in dropdown */
    .unread-count {
      display: none;
      background-color: #dc3545;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 8px;
      min-width: 18px;
      text-align: center;
    }

    .unread-count.show {
      display: inline-block;
    }

    /* Navbar spacing adjustments - desktop only */
    @media (min-width: 768px) {
      .navbar-nav {
        margin-left: 8rem !important;
      }

      .profile-nav-wrapper {
        margin-left: auto !important;
      }

      #signInWrapper {
        margin-left: auto !important;
      }
    }

    /* Mobile - keep left aligned */
    @media (max-width: 767px) {
      .navbar-nav {
        margin-left: 0 !important;
      }
    }

    .container {
      max-width: 700px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    .tag {
      background-color: #20bcba;
      color: white;
      border-radius: 15px;
      padding: 0.3rem 0.8rem;
      display: inline-block;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    button {
      background-color: #20bcba;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 0.25rem;
      width: auto;
      min-width: 120px;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #199c9a;
    }
    .secondary {
      background: #c0392b;
    }
    .avatar-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 1rem;
    }
    .profile-pic-preview {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #20bcba;
      background-color: #f0f0f0;
    }
    .avatar-edit-btn {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      min-width: 36px;
      padding: 0;
      margin: 0;
      border-radius: 50%;
      background: #20bcba;
      border: 2px solid white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .avatar-edit-btn:hover {
      background: #199c9a;
    }
    .avatar-edit-btn svg {
      width: 16px;
      height: 16px;
      fill: white;
    }
    #avatar {
      display: none;
    }
    .horizontal-btns {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .status-message {
      text-align: center;
      margin: 1rem 0;
      font-weight: 600;
    }

    /* Availability Schedule Grid */
    .schedule-day-row {
      display: grid;
      grid-template-columns: 100px 1fr 40px;
      gap: 1rem;
      align-items: start;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .schedule-day-row:last-child {
      border-bottom: none;
    }

    .day-label {
      font-weight: 600;
      color: #333;
      padding-top: 0.5rem;
    }

    .time-slots {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .time-slot {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .time-slot input[type="time"] {
      width: 110px;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .add-slot-btn, .remove-slot-btn {
      width: 32px;
      height: 32px;
      min-width: 32px;
      padding: 0;
      margin: 0;
      border: none;
      border-radius: 50%;
      background: #20bcba;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .remove-slot-btn {
      background: #dc3545;
    }

    .add-slot-btn:hover {
      background: #199c9a;
      transform: scale(1.1);
    }

    .remove-slot-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark navbar-custom fixed-top">
    <a class="navbar-brand logo-image" href="index.html"><img src="images/NewLogo8.png" alt="Lingua Bud"></a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-awesome fas fa-bars"></span>
      <span class="navbar-toggler-awesome fas fa-times"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link page-scroll" href="index.html#header">HOME <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="connect.html">CONNECT</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="instructors.html">INSTRUCTORS</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="Resources2.html">RESOURCES</a>
        </li>

        <!-- Dropdown Menu -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle page-scroll" href="#about" id="navbarDropdown" role="button" aria-haspopup="true" aria-expanded="false">LANGUAGES</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
			<a class="dropdown-item" href="EnglishPage.html"><span class="item-text">ENGLISH</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="NewSpanishPage.html"><span class="item-text">SPANISH</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="NewFrenchPage.html"><span class="item-text">FRENCH</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="NewPortuguesePage.html"><span class="item-text">PORTUGUESE</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="NewItalianPage.html"><span class="item-text">ITALIAN</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="GermanPage.html"><span class="item-text">GERMAN</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="RussianPage.html"><span class="item-text">RUSSIAN</span></a>
			<div class="dropdown-items-divide-hr"></div>
			<a class="dropdown-item" href="SwedishPage.html"><span class="item-text">SWEDISH</span></a>

          </div>
        </li>
        <!-- end of dropdown menu -->

        <li class="nav-item">
          <a class="nav-link page-scroll" href="index.html#contact">CONTACT</a>
        </li>

        <!-- Sign In Link (shown when not logged in) -->
        <li class="nav-item" id="signInWrapper">
          <a class="nav-link page-scroll" href="login.html">SIGN IN/SIGN UP</a>
        </li>
      </ul>

      <!-- Profile Picture Dropdown (shown when logged in) -->
      <div class="profile-nav-wrapper" id="profileNavWrapper" style="display: none;">
        <div class="profile-dropdown">
          <img id="navProfilePic" class="profile-pic-nav" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E" alt="Profile">
          <div class="notification-badge" id="notificationBadge"></div>
          <div class="profile-dropdown-content">
            <a href="student-dashboard.html"><i class="fas fa-user"></i> My Profile</a>
            <a href="messages.html"><i class="fas fa-envelope"></i> Messages</a>
            <a href="connect.html"><i class="fas fa-users"></i> Find Partners</a>
            <a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <!-- end of navbar -->

  <div class="container" id="profile-container">
    <label for="name">Full Name</label>
    <input type="text" id="name" />

    <label>Profile Picture</label>
    <div class="avatar-wrapper">
      <img id="avatarPreview" class="profile-pic-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E" alt="Profile" />
      <button type="button" class="avatar-edit-btn" id="avatar-edit-btn" title="Change photo">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
      </button>
      <input type="file" id="avatar" accept="image/*" />
    </div>


    <label for="spokenLanguage">Languages You Speak</label>
    <select id="spokenLanguage"></select>
    <div id="languages_spoken"></div>

    <label for="teachingLanguage">Languages You Teach</label>
    <select id="teachingLanguage"></select>
    <div id="languages_teaching"></div>

    <label for="price">Price Per Lesson</label>
    <input type="number" id="price" min="0" placeholder="Enter price" />
    <label for="currency">Currency</label>
    <select id="currency"></select>

    <label for="about_me">About Me</label>
    <textarea id="about_me" rows="5" placeholder="Write a short bio..."></textarea>

    <label for="country">Native Country</label>
    <select id="country"></select>

    <!-- AVAILABILITY SECTION -->
    <h3 style="margin-top: 2.5rem; margin-bottom: 1rem; color: #20bcba; border-bottom: 2px solid #20bcba; padding-bottom: 0.5rem;">
      <i class="fas fa-calendar-alt"></i> Teaching Availability
    </h3>

    <label for="timezone">Your Timezone</label>
    <select id="timezone" style="margin-bottom: 1.5rem;">
      <option value="">Select your timezone...</option>
    </select>

    <div style="margin-bottom: 2rem;">
      <label style="display: block; margin-bottom: 1rem;">Weekly Schedule</label>
      <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
        Set your regular teaching hours. All times are in your local timezone.
      </p>
      <div id="weekly-schedule-grid" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
        <!-- JavaScript will populate this -->
      </div>
    </div>

    <button type="button" id="save-availability-btn"
            style="background-color: #6c757d; margin-top: 0; margin-bottom: 2rem;">
      <i class="fas fa-save"></i> Save Availability
    </button>

    <div class="horizontal-btns">
      <button id="save-btn" type="button">Save Profile</button>
    </div>
    <div id="status" class="status-message"></div>
  </div>

  <!-- Scripts -->
  <script src="js/jquery.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.easing.min.js"></script>
  <script src="js/swiper.min.js"></script>
  <script src="js/jquery.magnific-popup.js"></script>
  <script src="js/morphext.min.js"></script>
  <script src="js/isotope.pkgd.min.js"></script>
  <script src="js/validator.min.js"></script>
  <script src="js/scripts.js"></script>

  <script type="module">
    import {
      auth,
      db,
      storage,
      signOut,
      onAuthStateChanged,
      doc,
      getDoc,
      setDoc,
      collection,
      getDocs,
      query,
      where,
      ref,
      uploadBytes,
      getDownloadURL,
      onSnapshot
    } from './lib/firebaseClient.js';

    // Language/country/currency data
    const languages = [
      "Mandarin Chinese", "Spanish", "English", "Hindi", "Arabic", "Bengali", "Portuguese", "Russian", "Urdu", "Indonesian",
      "German", "French", "Japanese", "Punjabi", "Turkish", "Vietnamese", "Korean", "Italian", "Thai", "Polish",
      "Ukrainian", "Persian", "Dutch", "Romanian", "Czech", "Greek", "Hungarian", "Swedish", "Hebrew", "Danish",
      "Norwegian", "Finnish", "Malayalam", "Telugu", "Tamil", "Marathi", "Swahili", "Javanese", "Burmese", "Serbian",
      "Slovak", "Croatian", "Bulgarian", "Malay", "Filipino", "Amharic", "Zulu", "Kazakh", "Nepali", "Sinhala"
    ];
    const countries = [
      "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
      "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia",
      "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada",
      "Cape Verde", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Brazzaville)", "Congo (Kinshasa)", "Costa Rica",
      "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "East Timor", "Ecuador",
      "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France",
      "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau",
      "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland",
      "Israel", "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait",
      "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
      "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico",
      "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru",
      "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman",
      "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
      "Puerto Rico", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent", "Samoa", "San Marino",
      "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
      "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
      "São Tomé and Príncipe", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey",
      "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu",
      "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
    ];
    const currencies = [
      { code: "USD", name: "US Dollar", symbol: "$" },
      { code: "EUR", name: "Euro", symbol: "€" },
      { code: "GBP", name: "British Pound", symbol: "£" },
      { code: "CAD", name: "Canadian Dollar", symbol: "$" },
      { code: "AUD", name: "Australian Dollar", symbol: "$" },
    ];

    // Default avatar placeholder (inline SVG)
    const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E";

    // Track selected languages
    let spokenLanguages = [];
    let teachingLanguages = [];
    let currentUser = null;

    // Availability data
    let weeklyScheduleData = {
      monday: [], tuesday: [], wednesday: [], thursday: [],
      friday: [], saturday: [], sunday: []
    };

    const commonTimezones = [
      'America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles',
      'America/Toronto', 'America/Mexico_City', 'America/Sao_Paulo', 'America/Buenos_Aires',
      'Europe/London', 'Europe/Paris', 'Europe/Berlin', 'Europe/Madrid', 'Europe/Rome',
      'Asia/Tokyo', 'Asia/Shanghai', 'Asia/Seoul', 'Asia/Singapore', 'Asia/Dubai',
      'Australia/Sydney', 'Australia/Melbourne', 'Pacific/Auckland'
    ];

    document.addEventListener("DOMContentLoaded", async () => {
      // Load cached avatar immediately
      const cachedAvatar = localStorage.getItem('instructor_avatar');
      if (cachedAvatar) {
        document.getElementById('avatarPreview').src = cachedAvatar;
      }

      populateSelect('spokenLanguage', languages);
      populateSelect('teachingLanguage', languages);
      populateSelect('country', countries);
      populateCurrency();
      populateTimezoneSelect();
      renderWeeklyScheduleGrid();

      // Auto-add languages when selected from dropdown
      document.getElementById('spokenLanguage').addEventListener('change', () => addLanguage('spoken'));
      document.getElementById('teachingLanguage').addEventListener('change', () => addLanguage('teaching'));
      document.getElementById('save-btn').onclick = saveProfile;
      document.getElementById('save-availability-btn').onclick = saveAvailability;

      // Logout from navbar
      const logoutLink = document.getElementById('logoutLink');
      if (logoutLink) {
        logoutLink.addEventListener('click', async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });
      }

      // Mobile dropdown toggle functionality
      const navProfilePic = document.getElementById('navProfilePic');
      const profileDropdown = document.querySelector('.profile-dropdown');
      const profileDropdownContent = document.querySelector('.profile-dropdown-content');

      if (navProfilePic && profileDropdownContent) {
        // Toggle dropdown on click (for mobile)
        navProfilePic.addEventListener('click', (e) => {
          e.stopPropagation();
          profileDropdownContent.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!profileDropdown.contains(e.target)) {
            profileDropdownContent.classList.remove('show');
          }
        });

        // Close dropdown when a link is clicked
        const dropdownLinks = profileDropdownContent.querySelectorAll('a');
        dropdownLinks.forEach(link => {
          link.addEventListener('click', () => {
            profileDropdownContent.classList.remove('show');
          });
        });
      }

      // Avatar edit button triggers file input
      document.getElementById('avatar-edit-btn').onclick = () => {
        document.getElementById('avatar').click();
      };

      // Avatar file upload
      document.getElementById('avatar').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUser) return;

        setStatus("Uploading photo...");
        try {
          const avatarRef = ref(storage, `avatars/${currentUser.uid}`);
          await uploadBytes(avatarRef, file);
          const downloadURL = await getDownloadURL(avatarRef);

          await setDoc(doc(db, 'instructors', currentUser.uid),
            { avatar_url: downloadURL }, { merge: true });

          document.getElementById('avatarPreview').src = downloadURL;
          localStorage.setItem('instructor_avatar', downloadURL);
          setStatus("Photo uploaded!", false);
        } catch (err) {
          console.error(err);
          setStatus("Photo upload failed: " + err.message, true);
        }
      });

      // Listen for auth state
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          await loadProfile();
          await loadAvailability();

          // Load unread message count
          try {
            await loadUnreadMessageCount();
          } catch (error) {
            console.error('Error loading unread messages:', error);
          }
        } else {
          setStatus("Not logged in!", true);
          window.location.href = "./login.html";
        }
      });
    });

    function populateSelect(id, items) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.text = item;
        select.appendChild(option);
      });
    }

    function populateCurrency() {
      const select = document.getElementById("currency");
      select.innerHTML = "";
      currencies.forEach(cur => {
        const option = document.createElement('option');
        option.value = cur.code;
        option.text = `${cur.symbol} ${cur.code}`;
        select.appendChild(option);
      });
    }

    function addLanguage(type) {
      const select = document.getElementById(type === 'spoken' ? 'spokenLanguage' : 'teachingLanguage');
      const value = select.value;
      const list = type === 'spoken' ? spokenLanguages : teachingLanguages;
      if (!value || list.includes(value)) return;
      list.push(value);
      renderLanguages();
      // Reset dropdown to empty/default
      select.value = '';
    }

    function renderLanguages() {
      const spokenDiv = document.getElementById('languages_spoken');
      spokenDiv.innerHTML = "";
      spokenLanguages.forEach(lang => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = lang;
        span.title = "Click to remove";
        span.onclick = function() {
          spokenLanguages = spokenLanguages.filter(l => l !== lang);
          renderLanguages();
        };
        spokenDiv.appendChild(span);
      });

      const teachingDiv = document.getElementById('languages_teaching');
      teachingDiv.innerHTML = "";
      teachingLanguages.forEach(lang => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = lang;
        span.title = "Click to remove";
        span.onclick = function() {
          teachingLanguages = teachingLanguages.filter(l => l !== lang);
          renderLanguages();
        };
        teachingDiv.appendChild(span);
      });
    }

    function setStatus(msg, isError) {
      const el = document.getElementById('status');
      el.textContent = msg || "";
      el.style.color = isError ? "red" : "green";
    }

    async function saveProfile() {
      setStatus("");
      if (!currentUser) {
        setStatus('Please log in first.', true);
        return;
      }

      const profile = {
        name: (document.getElementById('name').value || "").trim(),
        languages_spoken: spokenLanguages,
        languages_teaching: teachingLanguages,
        price_per_lesson: parseFloat(document.getElementById('price').value) || null,
        currency: document.getElementById('currency').value,
        about_me: (document.getElementById('about_me').value || "").trim(),
        native_country: document.getElementById('country').value,
        email: currentUser.email,
        updatedAt: new Date().toISOString()
      };

      try {
        await setDoc(doc(db, 'instructors', currentUser.uid), profile, { merge: true });
        setStatus("Profile saved successfully!", false);

        // Redirect to instructors page after saving
        setTimeout(() => {
          window.location.href = 'instructors.html';
        }, 1000);
      } catch (error) {
        setStatus("Error saving profile: " + error.message, true);
      }
    }

    async function loadProfile() {
      setStatus("Loading profile...");

      try {
        const docSnap = await getDoc(doc(db, 'instructors', currentUser.uid));

        // Clear fields first
        document.getElementById('name').value = "";
        document.getElementById('price').value = "";
        document.getElementById('currency').value = "USD";
        document.getElementById('about_me').value = "";
        document.getElementById('country').value = "";
        spokenLanguages = [];
        teachingLanguages = [];
        document.getElementById('avatarPreview').src = defaultAvatar;

        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('name').value = data.name || "";
          document.getElementById('price').value = data.price_per_lesson || "";
          document.getElementById('currency').value = data.currency || "USD";
          document.getElementById('about_me').value = data.about_me || "";
          document.getElementById('country').value = data.native_country || "";

          spokenLanguages = Array.isArray(data.languages_spoken) ? data.languages_spoken : [];
          teachingLanguages = Array.isArray(data.languages_teaching) ? data.languages_teaching : [];
          renderLanguages();

          if (data.avatar_url) {
            document.getElementById('avatarPreview').src = data.avatar_url;
            document.getElementById('navProfilePic').src = data.avatar_url;
            localStorage.setItem('instructor_avatar', data.avatar_url);
          }
        }
        setStatus("");
      } catch (error) {
        setStatus("Error loading profile: " + error.message, true);
      }
    }

    // AVAILABILITY FUNCTIONS

    function populateTimezoneSelect() {
      const select = document.getElementById('timezone');
      const detectedTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;

      select.innerHTML = '<option value="">Select your timezone...</option>';

      // Add detected timezone first if not in common list
      if (detectedTZ && !commonTimezones.includes(detectedTZ)) {
        select.innerHTML += `<option value="${detectedTZ}">${detectedTZ} (Detected)</option>`;
      }

      commonTimezones.forEach(tz => {
        const selected = tz === detectedTZ ? 'selected' : '';
        select.innerHTML += `<option value="${tz}" ${selected}>${tz}</option>`;
      });
    }

    function renderWeeklyScheduleGrid() {
      const container = document.getElementById('weekly-schedule-grid');
      const weekDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

      container.innerHTML = '';

      weekDays.forEach(day => {
        const dayRow = document.createElement('div');
        dayRow.className = 'schedule-day-row';

        dayRow.innerHTML = `
          <div class="day-label">${capitalizeFirst(day)}</div>
          <div class="time-slots" id="slots-${day}"></div>
          <button class="add-slot-btn" type="button" data-day="${day}" title="Add time slot">
            <i class="fas fa-plus"></i>
          </button>
        `;

        container.appendChild(dayRow);

        // Add click listener to add button
        dayRow.querySelector('.add-slot-btn').onclick = () => addTimeSlot(day);

        // Render existing slots
        const slots = weeklyScheduleData[day] || [];
        slots.forEach(slot => {
          renderTimeSlot(day, slot.start, slot.end);
        });
      });
    }

    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function addTimeSlot(day) {
      renderTimeSlot(day, '09:00', '17:00');
    }

    function renderTimeSlot(day, start = '09:00', end = '17:00') {
      const container = document.getElementById(`slots-${day}`);
      const slotDiv = document.createElement('div');
      slotDiv.className = 'time-slot';

      slotDiv.innerHTML = `
        <input type="time" class="slot-start" value="${start}" />
        <span style="color: #666;">to</span>
        <input type="time" class="slot-end" value="${end}" />
        <button class="remove-slot-btn" type="button" title="Remove slot">
          <i class="fas fa-times"></i>
        </button>
      `;

      container.appendChild(slotDiv);

      slotDiv.querySelector('.remove-slot-btn').onclick = () => {
        slotDiv.remove();
      };
    }

    async function saveAvailability() {
      if (!currentUser) {
        setStatus('Please log in first.', true);
        return;
      }

      const timezone = document.getElementById('timezone').value;
      if (!timezone) {
        setStatus('Please select your timezone.', true);
        return;
      }

      // Collect weekly schedule
      const weekDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const weeklySchedule = {};

      weekDays.forEach(day => {
        const slots = [];
        const slotElements = document.querySelectorAll(`#slots-${day} .time-slot`);

        slotElements.forEach(slotEl => {
          const start = slotEl.querySelector('.slot-start').value;
          const end = slotEl.querySelector('.slot-end').value;

          if (start && end && start < end) {
            slots.push({ start, end });
          }
        });

        weeklySchedule[day] = slots;
      });

      try {
        setStatus('Saving availability...', false);

        await setDoc(
          doc(db, 'instructor_availability', currentUser.uid),
          {
            timezone,
            weeklySchedule,
            updatedAt: new Date().toISOString()
          },
          { merge: true }
        );

        setStatus('Availability saved successfully!', false);

      } catch (error) {
        console.error('Error saving availability:', error);
        setStatus('Error saving availability: ' + error.message, true);
      }
    }

    async function loadAvailability() {
      if (!currentUser) return;

      try {
        const docSnap = await getDoc(doc(db, 'instructor_availability', currentUser.uid));

        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('timezone').value = data.timezone || '';

          weeklyScheduleData = data.weeklySchedule || {
            monday: [], tuesday: [], wednesday: [], thursday: [],
            friday: [], saturday: [], sunday: []
          };

          renderWeeklyScheduleGrid();
        }

      } catch (error) {
        console.error('Error loading availability:', error);
      }
    }

    // UNREAD MESSAGE COUNT

    async function loadUnreadMessageCount() {
      if (!auth.currentUser) return;

      const q = query(
        collection(db, 'conversations'),
        where('participants', 'array-contains', auth.currentUser.uid)
      );

      onSnapshot(q, (snapshot) => {
        let totalUnread = 0;

        snapshot.forEach((doc) => {
          const conv = doc.data();
          if (conv.unreadCount && conv.unreadCount[auth.currentUser.uid]) {
            totalUnread += conv.unreadCount[auth.currentUser.uid];
          }
        });

        const messagesLink = document.getElementById('messagesLink');
        const unreadCount = document.getElementById('unreadCount');
        const notificationBadge = document.getElementById('notificationBadge');

        if (messagesLink) {
          if (totalUnread > 0) {
            messagesLink.classList.add('has-unread');
          } else {
            messagesLink.classList.remove('has-unread');
          }
        }

        if (unreadCount) {
          if (totalUnread > 0) {
            unreadCount.textContent = totalUnread > 99 ? '99+' : totalUnread;
            unreadCount.classList.add('show');
          } else {
            unreadCount.classList.remove('show');
          }
        }

        if (notificationBadge) {
          if (totalUnread > 0) {
            notificationBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
            notificationBadge.classList.add('show');
          } else {
            notificationBadge.classList.remove('show');
          }
        }
      });
    }

  </script>
</body>
</html>