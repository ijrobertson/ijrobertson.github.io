<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instructor Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f4f4;
      color: #333;
      padding: 20px;
    }
    h1 {
      color: #20bcba;
      text-align: center;
    }
    .container {
      background-color: white;
      max-width: 700px;
      margin: 0 auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 20px;
      margin-bottom: 5px;
      font-weight: 600;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      background-color: #20bcba;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #169fa0;
    }
    .language-group ul {
      list-style: none;
      padding: 0;
      margin-top: 10px;
    }
    .language-group li {
      display: inline-block;
      background-color: #e0f7f7;
      color: #003;
      padding: 6px 10px;
      margin: 4px;
      border-radius: 6px;
    }
    .language-group li span {
      margin-left: 8px;
      color: red;
      cursor: pointer;
    }
    .profile-picture-preview {
      margin-top: 10px;
      max-width: 120px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Instructor Dashboard</h1>
    <label for="name">Full Name</label>
    <input type="text" id="name" />

    <label for="profile_picture">Profile Picture</label>
    <input type="file" id="profile_picture" accept="image/*" />
    <img id="preview" class="profile-picture-preview" style="display: none;" />

    <label>Language(s) You Speak</label>
    <div class="language-group">
      <select id="language_spoken_select"></select>
      <button type="button" onclick="addLanguage('spoken')">Add Language</button>
      <ul id="spoken_languages_list"></ul>
    </div>

    <label>Language(s) You Teach</label>
    <div class="language-group">
      <select id="language_select"></select>
      <button type="button" onclick="addLanguage('teach')">Add Language</button>
      <ul id="teach_languages_list"></ul>
    </div>

    <label for="price">Price per Lesson</label>
    <input type="number" id="price" min="0" step="0.01" />

    <label for="currency">Currency</label>
    <select id="currency">
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
      <option value="CAD">CAD</option>
      <option value="AUD">AUD</option>
      <option value="JPY">JPY</option>
      <option value="INR">INR</option>
      <option value="CNY">CNY</option>
    </select>

    <label for="bio">About Me</label>
    <textarea id="bio" rows="4"></textarea>

    <label for="country">Native Country</label>
    <select id="country"></select>

    <button id="save-btn">Save Profile</button>
    <p id="status"></p>
  </div>

  <script type="module">
    import { supabase } from './lib/supabaseClient.js';

    const languages = [ "Mandarin Chinese", "English", "Hindi", "Spanish", "French", "Arabic", "Bengali",
      "Russian", "Portuguese", "Urdu", "Indonesian", "German", "Japanese", "Swahili", "Marathi", "Telugu",
      "Turkish", "Tamil", "Vietnamese", "Korean", "Italian", "Thai", "Gujarati", "Polish", "Ukrainian", "Persian",
      "Malayalam", "Kannada", "Dutch", "Punjabi", "Romanian", "Greek", "Hungarian", "Czech", "Swedish",
      "Hebrew", "Norwegian", "Danish", "Finnish", "Serbian", "Slovak", "Bulgarian", "Croatian", "Nepali",
      "Sinhala", "Tagalog", "Amharic", "Zulu", "Hausa", "Burmese"
    ];

    const countries = await fetch('https://restcountries.com/v3.1/all')
      .then(res => res.json())
      .then(data => data.map(c => c.name.common).sort());

    const languageSelect = document.getElementById('language_select');
    const spokenSelect = document.getElementById('language_spoken_select');
    const countrySelect = document.getElementById('country');

    const spokenLanguages = new Set();
    const teachLanguages = new Set();

    languages.forEach(lang => {
      const option1 = new Option(lang, lang);
      const option2 = new Option(lang, lang);
      spokenSelect.appendChild(option1);
      languageSelect.appendChild(option2);
    });

    countries.forEach(country => {
      countrySelect.appendChild(new Option(country, country));
    });

    function renderLanguages(set, listId) {
      const ul = document.getElementById(listId);
      ul.innerHTML = '';
      set.forEach(lang => {
        const li = document.createElement('li');
        li.textContent = lang;
        const remove = document.createElement('span');
        remove.textContent = '❌';
        remove.onclick = () => {
          set.delete(lang);
          renderLanguages(set, listId);
        };
        li.appendChild(remove);
        ul.appendChild(li);
      });
    }

    window.addLanguage = function(type) {
      const select = type === 'spoken' ? spokenSelect : languageSelect;
      const list = type === 'spoken' ? spokenLanguages : teachLanguages;
      list.add(select.value);
      renderLanguages(list, type === 'spoken' ? 'spoken_languages_list' : 'teach_languages_list');
    };

    const user = (await supabase.auth.getUser()).data.user;
    const status = document.getElementById('status');

    if (user) {
      const { data, error } = await supabase
        .from('instructors')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (data) {
        document.getElementById('name').value = data.name || '';
        document.getElementById('price').value = data.price || '';
        document.getElementById('currency').value = data.currency || '';
        document.getElementById('bio').value = data.bio || '';
        document.getElementById('country').value = data.country || '';
        if (data.language) {
          data.language.forEach(l => teachLanguages.add(l));
          renderLanguages(teachLanguages, 'teach_languages_list');
        }
        if (data.language_spoken) {
          data.language_spoken.forEach(l => spokenLanguages.add(l));
          renderLanguages(spokenLanguages, 'spoken_languages_list');
        }
        if (data.profile_picture) {
          const preview = document.getElementById('preview');
          preview.src = data.profile_picture;
          preview.style.display = 'block';
        }
      }
    }

    document.getElementById('profile_picture').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const filePath = `${user.id}/${file.name}`;
      const { error } = await supabase.storage.from('avatars').upload(filePath, file, { upsert: true });
      if (!error) {
        const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(filePath);
        document.getElementById('preview').src = publicUrl;
        document.getElementById('preview').style.display = 'block';
        document.getElementById('preview').dataset.url = publicUrl;
      }
    });

    document.getElementById('save-btn').addEventListener('click', async () => {
      if (!user) return status.textContent = 'Not logged in.';
      const picture = document.getElementById('preview').dataset.url || '';

      const { error } = await supabase.from('instructors').upsert({
        user_id: user.id,
        name: document.getElementById('name').value,
        language: [...teachLanguages],
        language_spoken: [...spokenLanguages],
        price: parseFloat(document.getElementById('price').value),
        currency: document.getElementById('currency').value,
        bio: document.getElementById('bio').value,
        country: document.getElementById('country').value,
        profile_picture: picture
      }, { onConflict: ['user_id'] });

      status.textContent = error ? error.message : 'Profile saved!';
      status.style.color = error ? 'red' : 'green';
    });
  </script>
</body>
</html>
