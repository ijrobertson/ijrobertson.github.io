<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instructor Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f6f6f6;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 600px;
      margin: auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 15px rgba(0,0,0,0.1);
    }

    h1 {
      color: #20bcba;
      text-align: center;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    textarea {
      resize: vertical;
    }

    .language-group ul {
      list-style: none;
      padding: 0;
      margin-top: 10px;
    }

    .language-group li {
      display: inline-block;
      background-color: #e0f7f7;
      color: #003;
      padding: 6px 10px;
      margin: 4px;
      border-radius: 6px;
    }

    .language-group li span {
      margin-left: 8px;
      color: red;
      cursor: pointer;
    }

    button, input[type="submit"] {
      background-color: #20bcba;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
    }

    button:hover {
      background-color: #179b9b;
    }

    #status {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }

    .avatar-preview {
      margin-top: 10px;
      max-width: 120px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Instructor Dashboard</h1>
    <label for="name">Full Name</label>
    <input type="text" id="name" placeholder="Your name"/>

    <label for="language_spoken_select">Language(s) You Speak</label>
    <div class="language-group">
      <select id="language_spoken_select"></select>
      <button type="button" onclick="addLanguage('spoken')">Add Language</button>
      <ul id="spoken_languages_list"></ul>
    </div>

    <label for="language_select">Language(s) You Teach</label>
    <div class="language-group">
      <select id="language_select"></select>
      <button type="button" onclick="addLanguage('teach')">Add Language</button>
      <ul id="teach_languages_list"></ul>
    </div>

    <label for="price">Price Per Lesson</label>
    <input type="number" id="price" placeholder="e.g. 25" min="1"/>

    <label for="currency">Currency</label>
    <select id="currency">
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
      <option value="CAD">CAD</option>
      <option value="AUD">AUD</option>
      <option value="INR">INR</option>
      <option value="JPY">JPY</option>
    </select>

    <label for="bio">About Me</label>
    <textarea id="bio" rows="4" placeholder="Write a short bio..."></textarea>

    <label for="country">Native Country</label>
    <select id="country"></select>

    <label for="avatar">Profile Picture</label>
    <input type="file" id="avatar" accept="image/*"/>
    <img id="avatar-preview" class="avatar-preview" />

    <button id="save-btn">Save Profile</button>
    <div id="status"></div>
  </div>

  <script type="module">
    import { supabase } from './lib/supabaseClient.js';

    const topLanguages = ["English", "Mandarin Chinese", "Hindi", "Spanish", "French", "Arabic", "Bengali", "Russian", "Portuguese", "Urdu"];
    const otherLanguages = [
      "Amharic", "Burmese", "Czech", "Danish", "Dutch", "Finnish", "German", "Greek", "Gujarati", "Hebrew",
      "Hungarian", "Indonesian", "Italian", "Japanese", "Kannada", "Korean", "Malayalam", "Marathi", "Nepali",
      "Norwegian", "Persian", "Polish", "Punjabi", "Romanian", "Serbian", "Sinhala", "Slovak", "Swahili", "Swedish",
      "Tagalog", "Tamil", "Telugu", "Thai", "Turkish", "Twi", "Ukrainian", "Vietnamese", "Zulu"
    ];

    const countries = [
      "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
      "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia",
      "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada",
      "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic",
      "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia",
      "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Guatemala", "Guinea", "Guyana",
      "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Ivory Coast", "Jamaica",
      "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya",
      "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Mauritania", "Mexico",
      "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nepal", "Netherlands", "New Zealand",
      "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Panama", "Papua New Guinea",
      "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Puerto Rico", "Qatar", "Romania", "Russia", "Rwanda", "Saint Lucia", "Samoa", "Saudi Arabia",
      "Senegal", "Serbia", "Singapore", "Slovakia", "Slovenia", "Somalia", "South Africa", "South Korea", "Spain", "Sri Lanka", "Sudan",
      "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago",
      "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay",
      "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
    ];

    const languageSelect = document.getElementById('language_select');
    const spokenSelect = document.getElementById('language_spoken_select');
    const countrySelect = document.getElementById('country');

    function populateDropdown(select, items) {
      select.innerHTML = '';
      items.forEach(lang => {
        const option = document.createElement('option');
        option.value = lang;
        option.textContent = lang;
        select.appendChild(option);
      });
    }

    populateDropdown(spokenSelect, [...topLanguages, ...otherLanguages].sort((a, b) => a.localeCompare(b)));
    populateDropdown(languageSelect, [...topLanguages, ...otherLanguages].sort((a, b) => a.localeCompare(b)));
    populateDropdown(countrySelect, countries.sort((a, b) => a.localeCompare(b)));

    const teachLanguages = new Set();
    const spokenLanguages = new Set();

    function addLanguage(type) {
      const select = type === 'spoken' ? spokenSelect : languageSelect;
      const ul = document.getElementById(type === 'spoken' ? 'spoken_languages_list' : 'teach_languages_list');
      const lang = select.value;
      const list = type === 'spoken' ? spokenLanguages : teachLanguages;

      if (!list.has(lang)) {
        list.add(lang);
        const li = document.createElement('li');
        li.textContent = lang;
        const remove = document.createElement('span');
        remove.textContent = ' ❌';
        remove.onclick = () => {
          list.delete(lang);
          li.remove();
        };
        li.appendChild(remove);
        ul.appendChild(li);
      }
    }

    async function getUser() {
      const { data: { user } } = await supabase.auth.getUser();
      return user;
    }

    async function preloadProfile(user) {
      const { data, error } = await supabase
        .from('instructors')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (data) {
        document.getElementById('name').value = data.name || '';
        document.getElementById('price').value = data.price || '';
        document.getElementById('currency').value = data.currency || 'USD';
        document.getElementById('bio').value = data.bio || '';
        document.getElementById('country').value = data.country || '';
        if (data.avatar_url) document.getElementById('avatar-preview').src = data.avatar_url;

        (data.language || []).forEach(lang => {
          teachLanguages.add(lang);
          addLanguageToUI('teach', lang);
        });
        (data.language_spoken || []).forEach(lang => {
          spokenLanguages.add(lang);
          addLanguageToUI('spoken', lang);
        });
      }
    }

    function addLanguageToUI(type, lang) {
      const ul = document.getElementById(type === 'spoken' ? 'spoken_languages_list' : 'teach_languages_list');
      const li = document.createElement('li');
      li.textContent = lang;
      const remove = document.createElement('span');
      remove.textContent = ' ❌';
      remove.onclick = () => {
        (type === 'spoken' ? spokenLanguages : teachLanguages).delete(lang);
        li.remove();
      };
      li.appendChild(remove);
      ul.appendChild(li);
    }

    document.getElementById('avatar').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const user = await getUser();
      const filePath = `avatars/${user.id}_${file.name}`;
      const { data, error } = await supabase.storage.from('avatars').upload(filePath, file, { upsert: true });

      if (!error) {
        const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(filePath);
        document.getElementById('avatar-preview').src = publicUrl;
        document.getElementById('avatar-preview').dataset.url = publicUrl;
      }
    });

    document.getElementById('save-btn').addEventListener('click', async () => {
      const user = await getUser();
      if (!user) return alert('Not logged in');

      const profile = {
        user_id: user.id,
        name: document.getElementById('name').value,
        language: [...teachLanguages],
        language_spoken: [...spokenLanguages],
        price: parseFloat(document.getElementById('price').value),
        currency: document.getElementById('currency').value,
        bio: document.getElementById('bio').value,
        country: document.getElementById('country').value,
        avatar_url: document.getElementById('avatar-preview').dataset.url || ''
      };

      const { error } = await supabase
        .from('instructors')
        .upsert(profile, { onConflict: ['user_id'] });

      const status = document.getElementById('status');
      status.textContent = error ? error.message : 'Profile saved!';
      status.style.color = error ? 'red' : 'green';
    });

    (async () => {
      const user = await getUser();
      if (user) await preloadProfile(user);
    })();
  </script>
</body>
</html>
