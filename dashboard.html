<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instructor Dashboard</title>

  <!-- Styles -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:500,700&display=swap&subset=latin-ext" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600&display=swap&subset=latin-ext" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet">
  <link href="css/bootstrap.css" rel="stylesheet">
  <link href="css/fontawesome-all.css" rel="stylesheet">
  <link href="css/swiper.css" rel="stylesheet">
  <link href="css/magnific-popup.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">

  <!-- Favicon  -->
  <link rel="icon" href="images/NuevoFavicon.png">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 4.5rem 0 0;
      color: #333;
    }

    /* Navbar styles */
    .navbar-custom {
      background-color: #113448 !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .profile-nav-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .profile-pic-nav {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #20bcba;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .profile-pic-nav:hover {
      transform: scale(1.1);
    }

    .profile-dropdown {
      position: relative;
      display: inline-block;
    }

    .profile-dropdown-content {
      position: fixed;
      right: 1rem;
      top: 60px;
      background-color: white;
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
      transition-delay: 0s;
    }

    /* Desktop: position relative to parent */
    @media (min-width: 992px) {
      .profile-dropdown-content {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.25rem;
      }
    }

    .profile-dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background 0.2s;
    }

    .profile-dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .profile-dropdown:hover .profile-dropdown-content {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      transition-delay: 0s;
    }

    .profile-dropdown-content:hover {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* Mobile support - show dropdown when clicked */
    .profile-dropdown-content.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .profile-dropdown-content a.messages-link i {
      transition: color 0.2s;
    }

    .profile-dropdown-content a.messages-link.has-unread i {
      color: #dc3545;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Notification badge on profile picture */
    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background-color: #dc3545;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      border: 2px solid white;
      animation: badgePulse 2s infinite;
    }

    .notification-badge.show {
      display: flex;
    }

    @keyframes badgePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Unread count badge in dropdown */
    .unread-count {
      display: none;
      background-color: #dc3545;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 8px;
      min-width: 18px;
      text-align: center;
    }

    .unread-count.show {
      display: inline-block;
    }

    /* Navbar spacing - center nav links, right-align icons */
    @media (min-width: 768px) {
      .navbar-nav {
        margin: 0 auto !important;
      }

      .navbar-right-group {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        flex-shrink: 0;
      }
    }

    /* Mobile - keep left aligned */
    @media (max-width: 767px) {
      .navbar-nav {
        margin-left: 0 !important;
      }

      .navbar-right-group {
        padding: 0.5rem 0;
      }
    }

    .container {
      max-width: 700px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    .tag {
      background-color: #20bcba;
      color: white;
      border-radius: 15px;
      padding: 0.3rem 0.8rem;
      display: inline-block;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    button {
      background-color: #20bcba;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 0.25rem;
      width: auto;
      min-width: 120px;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #199c9a;
    }
    .secondary {
      background: #c0392b;
    }
    .avatar-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 1rem;
    }
    .profile-pic-preview {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #20bcba;
      background-color: #f0f0f0;
    }
    .avatar-edit-btn {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      min-width: 36px;
      padding: 0;
      margin: 0;
      border-radius: 50%;
      background: #20bcba;
      border: 2px solid white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .avatar-edit-btn:hover {
      background: #199c9a;
    }
    .avatar-edit-btn svg {
      width: 16px;
      height: 16px;
      fill: white;
    }
    #avatar {
      display: none;
    }
    .horizontal-btns {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .status-message {
      text-align: center;
      margin: 1rem 0;
      font-weight: 600;
    }

    /* Availability Schedule Grid */
    .schedule-day-row {
      display: grid;
      grid-template-columns: 100px 1fr 40px;
      gap: 1rem;
      align-items: start;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .schedule-day-row:last-child {
      border-bottom: none;
    }

    .day-label {
      font-weight: 600;
      color: #333;
      padding-top: 0.5rem;
    }

    .time-slots {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .time-slot {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .time-slot input[type="time"] {
      width: 110px;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .add-slot-btn, .remove-slot-btn {
      width: 32px;
      height: 32px;
      min-width: 32px;
      padding: 0;
      margin: 0;
      border: none;
      border-radius: 50%;
      background: #20bcba;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .remove-slot-btn {
      background: #dc3545;
    }

    .add-slot-btn:hover {
      background: #199c9a;
      transform: scale(1.1);
    }

    .remove-slot-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }

    /* ── Danger Zone ─────────────────────────── */
    .danger-card {
      background: #fff;
      border-radius: 10px;
      border: 1.5px solid #fde8e8;
      padding: 2rem;
      margin-top: 2rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .danger-header {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      margin-bottom: 0.5rem;
    }
    .danger-header i { color: #c0392b; font-size: 1rem; }
    .danger-header h3 { font-size: 1rem; font-weight: 700; color: #c0392b; margin: 0; }
    .danger-card > p { font-size: 0.875rem; color: #64748b; line-height: 1.65; margin: 0 0 1.5rem; }
    .btn-delete-account {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: #fff;
      color: #c0392b;
      border: 1.5px solid #c0392b;
      border-radius: 7px;
      padding: 0.65rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-delete-account:hover { background: #c0392b; color: #fff; }

    /* ── Delete Confirmation Modal ───────────── */
    .del-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .del-backdrop.active { display: flex; }
    .del-modal {
      background: #fff;
      border-radius: 16px;
      padding: 2.5rem 2rem 2rem;
      max-width: 420px;
      width: 100%;
      text-align: center;
      box-shadow: 0 24px 64px rgba(0,0,0,0.22);
      animation: delSlideUp 0.22s ease;
    }
    @keyframes delSlideUp {
      from { transform: translateY(18px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    .del-icon {
      width: 64px;
      height: 64px;
      background: #fde8e8;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.25rem;
      font-size: 1.5rem;
      color: #c0392b;
    }
    .del-modal h3 { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; margin: 0 0 0.6rem; }
    .del-modal p  { font-size: 0.875rem; color: #64748b; line-height: 1.65; margin: 0 0 1.75rem; }
    .del-btns { display: flex; gap: 0.75rem; }
    .del-btn-cancel {
      flex: 1; padding: 0.72rem; border-radius: 7px;
      border: 1.5px solid #d0d5dd; background: #fff;
      font-weight: 600; font-size: 0.875rem; color: #334155; cursor: pointer; transition: all 0.2s;
    }
    .del-btn-cancel:hover { background: #f1f5f9; }
    .del-btn-confirm {
      flex: 1; padding: 0.72rem; border-radius: 7px;
      border: none; background: #c0392b; color: #fff;
      font-weight: 700; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;
    }
    .del-btn-confirm:hover { background: #a93226; }
    .del-btn-confirm:disabled { opacity: 0.6; cursor: not-allowed; }
    .del-error { font-size: 0.8rem; color: #c0392b; margin-top: 1rem; display: none; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark navbar-custom fixed-top">
    <a class="navbar-brand logo-image" href="index.html"><img src="images/NewLogo8.png" alt="Lingua Bud"></a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-awesome fas fa-bars"></span>
      <span class="navbar-toggler-awesome fas fa-times"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link page-scroll" href="index.html#header">HOME <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="connect.html">CONNECT</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="instructors.html">INSTRUCTORS</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="Resources2.html">RESOURCES</a>
        </li>

        <!-- Dropdown Menu -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle page-scroll" href="#about" id="navbarDropdown" role="button" aria-haspopup="true" aria-expanded="false">LANGUAGES</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
			<a class="dropdown-item" href="EnglishPage.html"><span class="item-text">ENGLISH</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="NewSpanishPage.html"><span class="item-text">SPANISH</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="NewFrenchPage.html"><span class="item-text">FRENCH</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="NewPortuguesePage.html"><span class="item-text">PORTUGUESE</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="NewItalianPage.html"><span class="item-text">ITALIAN</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="GermanPage.html"><span class="item-text">GERMAN</span></a>
                        <div class="dropdown-items-divide-hr"></div>
                        <a class="dropdown-item" href="RussianPage.html"><span class="item-text">RUSSIAN</span></a>
			<div class="dropdown-items-divide-hr"></div>
			<a class="dropdown-item" href="SwedishPage.html"><span class="item-text">SWEDISH</span></a>

          </div>
        </li>
        <!-- end of dropdown menu -->

        <li class="nav-item">
          <a class="nav-link page-scroll" href="index.html#contact">CONTACT</a>
        </li>
      </ul>

      <!-- Right-side navbar group: sign-in, profile pic, social icons -->
      <div class="navbar-right-group">

        <!-- Sign In Link (shown when not logged in) -->
        <a class="nav-link" href="login.html" id="signInWrapper">SIGN IN/SIGN UP</a>

        <!-- Profile Picture Dropdown (shown when logged in) -->
        <div class="profile-nav-wrapper" id="profileNavWrapper" style="display: none;">
          <div class="profile-dropdown">
            <img id="navProfilePic" class="profile-pic-nav" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E" alt="Profile">
            <div class="notification-badge" id="notificationBadge"></div>
            <div class="profile-dropdown-content">
              <a href="dashboard.html"><i class="fas fa-user"></i> My Profile</a>
              <a href="messages.html" class="messages-link" id="messagesLink"><i class="fas fa-envelope"></i> Messages <span class="unread-count" id="unreadCount"></span></a>
              <a href="activity.html"><i class="fas fa-bell"></i> Activity <span class="unread-count" id="activityCount"></span></a>
              <a href="connect.html"><i class="fas fa-users"></i> Find Partners</a>
              <a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
          </div>
        </div>

        <!-- Social Icons -->
        <span class="nav-item social-icons">
          <span class="fa-stack">
            <a href="https://www.facebook.com/profile.php?id=61552700502857" target="_blank">
              <span class="hexagon"></span>
              <i class="fab fa-facebook-f fa-stack-1x"></i>
            </a>
          </span>
          <span class="fa-stack">
            <a href="https://www.instagram.com/lingua_bud/" target="_blank">
              <span class="hexagon"></span>
              <i class="fab fa-instagram fa-stack-1x"></i>
            </a>
          </span>
        </span>

      </div>
    </div>
  </nav>
  <!-- end of navbar -->

  <div class="container" id="profile-container">
    <label for="name">Full Name</label>
    <input type="text" id="name" />

    <label>Profile Picture</label>
    <div class="avatar-wrapper">
      <img id="avatarPreview" class="profile-pic-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E" alt="Profile" />
      <button type="button" class="avatar-edit-btn" id="avatar-edit-btn" title="Change photo">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
      </button>
      <input type="file" id="avatar" accept="image/*" />
    </div>


    <label for="spokenLanguage">Languages You Speak</label>
    <select id="spokenLanguage"></select>
    <div id="languages_spoken"></div>

    <label for="teachingLanguage">Languages You Teach</label>
    <select id="teachingLanguage"></select>
    <div id="languages_teaching"></div>

    <label for="price">Price Per Lesson</label>
    <input type="number" id="price" min="0" placeholder="Enter price" />
    <label for="currency">Currency</label>
    <select id="currency"></select>

    <label for="about_me">About Me</label>
    <textarea id="about_me" rows="5" placeholder="Write a short bio..."></textarea>

    <label for="country">Native Country</label>
    <select id="country"></select>

    <!-- AVAILABILITY SECTION -->
    <h3 style="margin-top: 2.5rem; margin-bottom: 1rem; color: #20bcba; border-bottom: 2px solid #20bcba; padding-bottom: 0.5rem;">
      <i class="fas fa-calendar-alt"></i> Teaching Availability
    </h3>

    <label for="timezone">Your Timezone</label>
    <select id="timezone" style="margin-bottom: 1.5rem;">
      <option value="">Select your timezone...</option>
    </select>

    <div style="margin-bottom: 2rem;">
      <label style="display: block; margin-bottom: 1rem;">Weekly Schedule</label>
      <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
        Set your regular teaching hours. All times are in your local timezone.
      </p>
      <div id="weekly-schedule-grid" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
        <!-- JavaScript will populate this -->
      </div>
    </div>

    <button type="button" id="save-availability-btn"
            style="background-color: #6c757d; margin-top: 0; margin-bottom: 2rem;">
      <i class="fas fa-save"></i> Save Availability
    </button>

    <div class="horizontal-btns">
      <button id="save-btn" type="button">Save Profile</button>
    </div>
    <div id="status" class="status-message"></div>

    <!-- PAYMENT SETUP SECTION -->
    <h3 style="margin-top: 2.5rem; margin-bottom: 1rem; color: #20bcba; border-bottom: 2px solid #20bcba; padding-bottom: 0.5rem;">
      <i class="fas fa-credit-card"></i> Payment Setup
    </h3>
    <div id="stripe-status-section">
      <p style="color: #666; font-size: 0.9rem;">Loading payment status...</p>
    </div>

    <!-- Danger Zone -->
    <div class="danger-card">
      <div class="danger-header">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Danger Zone</h3>
      </div>
      <p>Permanently delete your Lingua Bud instructor account and all associated data. This action is irreversible and cannot be undone.</p>
      <button class="btn-delete-account" id="open-delete-modal">
        <i class="fas fa-trash-alt"></i> Delete My Account
      </button>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div class="del-backdrop" id="del-backdrop">
    <div class="del-modal">
      <div class="del-icon">
        <i class="fas fa-trash-alt"></i>
      </div>
      <h3>Delete your account?</h3>
      <p>This will permanently remove your Lingua Bud instructor profile and all your data from our platform. <strong>This cannot be undone.</strong></p>
      <div class="del-btns">
        <button class="del-btn-cancel" id="del-cancel">Keep My Account</button>
        <button class="del-btn-confirm" id="del-confirm">
          <span id="del-btn-text">Yes, Delete Account</span>
        </button>
      </div>
      <div class="del-error" id="del-error"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/jquery.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.easing.min.js"></script>
  <script src="js/swiper.min.js"></script>
  <script src="js/jquery.magnific-popup.js"></script>
  <script src="js/morphext.min.js"></script>
  <script src="js/isotope.pkgd.min.js"></script>
  <script src="js/validator.min.js"></script>
  <script src="js/scripts.js"></script>

  <script type="module">
    import {
      auth,
      db,
      storage,
      functions,
      signOut,
      onAuthStateChanged,
      deleteUser,
      doc,
      getDoc,
      setDoc,
      deleteDoc,
      collection,
      getDocs,
      query,
      where,
      ref,
      uploadBytes,
      getDownloadURL,
      onSnapshot,
      httpsCallable
    } from './lib/firebaseClient.js';

    // Language/country/currency data
    const languages = [
      "Afrikaans", "Akan", "Albanian", "Amharic", "Arabic", "Armenian", "Assamese", "Aymara", "Azerbaijani",
      "Bambara", "Bangla", "Basque", "Belarusian", "Bhojpuri", "Bosnian", "Bulgarian", "Burmese",
      "Cantonese", "Catalan", "Cebuano", "Central Kurdish", "Chinese (Simplified)", "Chinese (Traditional)", "Corsican", "Croatian", "Czech",
      "Danish", "Divehi", "Dogri", "Dutch",
      "English", "Esperanto", "Estonian", "Ewe",
      "Filipino", "Finnish", "French",
      "Galician", "Ganda", "Georgian", "German", "Goan Konkani", "Greek", "Greenlandic", "Guarani", "Gujarati",
      "Haitian Creole", "Hausa", "Hawaiian", "Hebrew", "Hindi", "Hmong", "Hungarian",
      "Icelandic", "Igbo", "Iloko", "Indonesian", "Irish", "Italian",
      "Japanese", "Javanese",
      "Kannada", "Kazakh", "Khmer", "Kinyarwanda", "Klingon", "Korean", "Krio", "Kurdish", "Kyrgyz",
      "Lao", "Latin", "Latvian", "Lingala", "Lithuanian", "Luxembourgish",
      "Macedonian", "Maithili", "Malagasy", "Malay", "Malayalam", "Maltese", "Manipuri (Meitei Mayek)", "Māori", "Marathi", "Mizo", "Mongolian",
      "Nahuatl", "Nepali", "Northern Sotho", "Norwegian", "Nyanja",
      "Odia", "Oromo",
      "Papiamento", "Pashto", "Persian", "Polish", "Portuguese", "Punjabi",
      "Quechua",
      "Romanian", "Romansh", "Russian",
      "Samoan", "Sanskrit", "Scottish Gaelic", "Serbian", "Shona", "Silbo Gomero", "Sindhi", "Sinhala", "Slovak", "Slovenian", "Somali", "Southern Sotho", "Spanish", "Sundanese", "Swahili", "Swedish",
      "Tagalog", "Tajik", "Tamil", "Tatar", "Telugu", "Thai", "Tigrinya", "Tok Pisin", "Tsonga", "Turkish", "Turkmen", "Twi",
      "Ukrainian", "Urdu", "Uyghur", "Uzbek",
      "Vietnamese",
      "Welsh", "Western Frisian", "Wu Chinese",
      "Xhosa",
      "Yiddish", "Yoruba", "Yue Chinese",
      "Zulu"
    ];
    const countries = [
      "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
      "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia",
      "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada",
      "Cape Verde", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Brazzaville)", "Congo (Kinshasa)", "Costa Rica",
      "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "East Timor", "Ecuador",
      "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France",
      "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau",
      "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland",
      "Israel", "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait",
      "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
      "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico",
      "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru",
      "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman",
      "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
      "Puerto Rico", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent", "Samoa", "San Marino",
      "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
      "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
      "São Tomé and Príncipe", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey",
      "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu",
      "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
    ];
    const currencies = [
      { code: "USD", name: "US Dollar", symbol: "$" },
      { code: "EUR", name: "Euro", symbol: "€" },
      { code: "GBP", name: "British Pound", symbol: "£" },
      { code: "CAD", name: "Canadian Dollar", symbol: "$" },
      { code: "AUD", name: "Australian Dollar", symbol: "$" },
    ];

    // Default avatar placeholder (inline SVG)
    const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E";

    // Track selected languages
    let spokenLanguages = [];
    let teachingLanguages = [];
    let currentUser = null;
    let avatarSet = false; // true once a photo is uploaded or already exists

    // Availability data
    let weeklyScheduleData = {
      monday: [], tuesday: [], wednesday: [], thursday: [],
      friday: [], saturday: [], sunday: []
    };

    const commonTimezones = [
      'America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles',
      'America/Toronto', 'America/Mexico_City', 'America/Sao_Paulo', 'America/Buenos_Aires',
      'Europe/London', 'Europe/Paris', 'Europe/Berlin', 'Europe/Madrid', 'Europe/Rome',
      'Asia/Tokyo', 'Asia/Shanghai', 'Asia/Seoul', 'Asia/Singapore', 'Asia/Dubai',
      'Australia/Sydney', 'Australia/Melbourne', 'Pacific/Auckland'
    ];

    document.addEventListener("DOMContentLoaded", async () => {
      // Load cached avatar immediately
      const cachedAvatar = localStorage.getItem('instructor_avatar');
      if (cachedAvatar) {
        document.getElementById('avatarPreview').src = cachedAvatar;
      }

      populateSelect('spokenLanguage', languages);
      populateSelect('teachingLanguage', languages);
      populateSelect('country', countries);
      populateCurrency();
      populateTimezoneSelect();
      renderWeeklyScheduleGrid();

      // Auto-add languages when selected from dropdown
      document.getElementById('spokenLanguage').addEventListener('change', () => addLanguage('spoken'));
      document.getElementById('teachingLanguage').addEventListener('change', () => addLanguage('teaching'));
      document.getElementById('save-btn').onclick = saveProfile;
      document.getElementById('save-availability-btn').onclick = saveAvailability;

      // Logout from navbar
      const logoutLink = document.getElementById('logoutLink');
      if (logoutLink) {
        logoutLink.addEventListener('click', async (e) => {
          e.preventDefault();
          await signOut(auth);
          window.location.href = "login.html";
        });
      }

      // Mobile dropdown toggle functionality
      const navProfilePic = document.getElementById('navProfilePic');
      const profileDropdown = document.querySelector('.profile-dropdown');
      const profileDropdownContent = document.querySelector('.profile-dropdown-content');

      if (navProfilePic && profileDropdownContent) {
        // Toggle dropdown on click (for mobile)
        navProfilePic.addEventListener('click', (e) => {
          e.stopPropagation();
          profileDropdownContent.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!profileDropdown.contains(e.target)) {
            profileDropdownContent.classList.remove('show');
          }
        });

        // Close dropdown when a link is clicked
        const dropdownLinks = profileDropdownContent.querySelectorAll('a');
        dropdownLinks.forEach(link => {
          link.addEventListener('click', () => {
            profileDropdownContent.classList.remove('show');
          });
        });
      }

      // Avatar edit button triggers file input
      document.getElementById('avatar-edit-btn').onclick = () => {
        document.getElementById('avatar').click();
      };

      // Avatar file upload
      document.getElementById('avatar').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUser) return;

        setStatus("Uploading photo...");
        try {
          const avatarRef = ref(storage, `avatars/${currentUser.uid}`);
          await uploadBytes(avatarRef, file);
          const downloadURL = await getDownloadURL(avatarRef);

          await setDoc(doc(db, 'instructors', currentUser.uid),
            { avatar_url: downloadURL }, { merge: true });

          document.getElementById('avatarPreview').src = downloadURL;
          localStorage.setItem('instructor_avatar', downloadURL);
          avatarSet = true;
          setStatus("Photo uploaded!", false);
        } catch (err) {
          console.error(err);
          setStatus("Photo upload failed: " + err.message, true);
        }
      });

      // Listen for auth state
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;

          // Show profile pic in navbar, hide sign-in link
          const profileNavWrapper = document.getElementById('profileNavWrapper');
          const signInWrapper = document.getElementById('signInWrapper');
          if (profileNavWrapper) profileNavWrapper.style.display = 'flex';
          if (signInWrapper) signInWrapper.style.display = 'none';

          await loadProfile();
          await loadAvailability();

          // Check Stripe payment setup status
          const urlParams = new URLSearchParams(window.location.search);
          await checkStripePaymentStatus(urlParams.get('stripe') === 'success');

          // Load unread message count
          try {
            await loadUnreadMessageCount();
            loadPendingRequests();
          } catch (error) {
            console.error('Error loading unread messages:', error);
          }
        } else {
          setStatus("Not logged in!", true);
          window.location.href = "./login.html";
        }
      });
    });

    function populateSelect(id, items) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.text = item;
        select.appendChild(option);
      });
    }

    function populateCurrency() {
      const select = document.getElementById("currency");
      select.innerHTML = "";
      currencies.forEach(cur => {
        const option = document.createElement('option');
        option.value = cur.code;
        option.text = `${cur.symbol} ${cur.code}`;
        select.appendChild(option);
      });
    }

    function addLanguage(type) {
      const select = document.getElementById(type === 'spoken' ? 'spokenLanguage' : 'teachingLanguage');
      const value = select.value;
      const list = type === 'spoken' ? spokenLanguages : teachingLanguages;
      if (!value || list.includes(value)) return;
      list.push(value);
      renderLanguages();
      // Reset dropdown to empty/default
      select.value = '';
    }

    function renderLanguages() {
      const spokenDiv = document.getElementById('languages_spoken');
      spokenDiv.innerHTML = "";
      spokenLanguages.forEach(lang => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = lang;
        span.title = "Click to remove";
        span.onclick = function() {
          spokenLanguages = spokenLanguages.filter(l => l !== lang);
          renderLanguages();
        };
        spokenDiv.appendChild(span);
      });

      const teachingDiv = document.getElementById('languages_teaching');
      teachingDiv.innerHTML = "";
      teachingLanguages.forEach(lang => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = lang;
        span.title = "Click to remove";
        span.onclick = function() {
          teachingLanguages = teachingLanguages.filter(l => l !== lang);
          renderLanguages();
        };
        teachingDiv.appendChild(span);
      });
    }

    function setStatus(msg, isError) {
      const el = document.getElementById('status');
      el.textContent = msg || "";
      el.style.color = isError ? "red" : "green";
    }

    async function saveProfile() {
      setStatus("");
      if (!currentUser) {
        setStatus('Please log in first.', true);
        return;
      }

      // ── Required field validation ──────────────────────────────
      const name = (document.getElementById('name').value || "").trim();
      const about_me = (document.getElementById('about_me').value || "").trim();

      if (!name) {
        setStatus('Please enter your full name.', true);
        document.getElementById('name').focus();
        return;
      }
      if (teachingLanguages.length === 0) {
        setStatus('Please add at least one language you teach.', true);
        return;
      }
      if (!about_me) {
        setStatus('Please write a short bio in the About Me section.', true);
        document.getElementById('about_me').focus();
        return;
      }
      if (!avatarSet) {
        setStatus('Please upload a profile picture before saving.', true);
        return;
      }

      const profile = {
        name,
        languages_spoken: spokenLanguages,
        languages_teaching: teachingLanguages,
        price_per_lesson: parseFloat(document.getElementById('price').value) || null,
        currency: document.getElementById('currency').value,
        about_me,
        native_country: document.getElementById('country').value,
        email: currentUser.email,
        updatedAt: new Date().toISOString()
      };

      try {
        setStatus("Saving profile...", false);

        // Save profile and availability together so the instructor
        // doesn't need to click "Save Availability" separately
        const saves = [
          setDoc(doc(db, 'instructors', currentUser.uid), profile, { merge: true })
        ];

        // Only save availability if a timezone has been selected
        const timezone = document.getElementById('timezone').value;
        if (timezone) {
          const weekDays = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
          const weeklySchedule = {};
          weekDays.forEach(day => {
            const slots = [];
            document.querySelectorAll(`#slots-${day} .time-slot`).forEach(slotEl => {
              const start = slotEl.querySelector('.slot-start').value;
              const end   = slotEl.querySelector('.slot-end').value;
              if (start && end && start < end) slots.push({ start, end });
            });
            weeklySchedule[day] = slots;
          });

          saves.push(
            setDoc(doc(db, 'instructor_availability', currentUser.uid),
              { timezone, weeklySchedule, updatedAt: new Date().toISOString() },
              { merge: true })
          );
        }

        await Promise.all(saves);
        setStatus("Profile saved successfully!", false);

        setTimeout(() => {
          window.location.href = 'instructors.html';
        }, 1000);
      } catch (error) {
        setStatus("Error saving profile: " + error.message, true);
      }
    }

    async function loadProfile() {
      setStatus("Loading profile...");

      try {
        const docSnap = await getDoc(doc(db, 'instructors', currentUser.uid));

        // Clear fields first
        document.getElementById('name').value = "";
        document.getElementById('price').value = "";
        document.getElementById('currency').value = "USD";
        document.getElementById('about_me').value = "";
        document.getElementById('country').value = "";
        spokenLanguages = [];
        teachingLanguages = [];
        document.getElementById('avatarPreview').src = defaultAvatar;

        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('name').value = data.name || "";
          document.getElementById('price').value = data.price_per_lesson || "";
          document.getElementById('currency').value = data.currency || "USD";
          document.getElementById('about_me').value = data.about_me || "";
          document.getElementById('country').value = data.native_country || "";

          spokenLanguages = Array.isArray(data.languages_spoken) ? data.languages_spoken : [];
          teachingLanguages = Array.isArray(data.languages_teaching) ? data.languages_teaching : [];
          renderLanguages();

          if (data.avatar_url) {
            document.getElementById('avatarPreview').src = data.avatar_url;
            document.getElementById('navProfilePic').src = data.avatar_url;
            localStorage.setItem('instructor_avatar', data.avatar_url);
            avatarSet = true;
          }
        }
        setStatus("");
      } catch (error) {
        setStatus("Error loading profile: " + error.message, true);
      }
    }

    // AVAILABILITY FUNCTIONS

    function populateTimezoneSelect() {
      const select = document.getElementById('timezone');
      const detectedTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;

      select.innerHTML = '<option value="">Select your timezone...</option>';

      // Add detected timezone first if not in common list
      if (detectedTZ && !commonTimezones.includes(detectedTZ)) {
        select.innerHTML += `<option value="${detectedTZ}">${detectedTZ} (Detected)</option>`;
      }

      commonTimezones.forEach(tz => {
        const selected = tz === detectedTZ ? 'selected' : '';
        select.innerHTML += `<option value="${tz}" ${selected}>${tz}</option>`;
      });
    }

    function renderWeeklyScheduleGrid() {
      const container = document.getElementById('weekly-schedule-grid');
      const weekDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

      container.innerHTML = '';

      weekDays.forEach(day => {
        const dayRow = document.createElement('div');
        dayRow.className = 'schedule-day-row';

        dayRow.innerHTML = `
          <div class="day-label">${capitalizeFirst(day)}</div>
          <div class="time-slots" id="slots-${day}"></div>
          <button class="add-slot-btn" type="button" data-day="${day}" title="Add time slot">
            <i class="fas fa-plus"></i>
          </button>
        `;

        container.appendChild(dayRow);

        // Add click listener to add button
        dayRow.querySelector('.add-slot-btn').onclick = () => addTimeSlot(day);

        // Render existing slots
        const slots = weeklyScheduleData[day] || [];
        slots.forEach(slot => {
          renderTimeSlot(day, slot.start, slot.end);
        });
      });
    }

    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function addTimeSlot(day) {
      renderTimeSlot(day, '09:00', '17:00');
    }

    function renderTimeSlot(day, start = '09:00', end = '17:00') {
      const container = document.getElementById(`slots-${day}`);
      const slotDiv = document.createElement('div');
      slotDiv.className = 'time-slot';

      slotDiv.innerHTML = `
        <input type="time" class="slot-start" value="${start}" />
        <span style="color: #666;">to</span>
        <input type="time" class="slot-end" value="${end}" />
        <button class="remove-slot-btn" type="button" title="Remove slot">
          <i class="fas fa-times"></i>
        </button>
      `;

      container.appendChild(slotDiv);

      slotDiv.querySelector('.remove-slot-btn').onclick = () => {
        slotDiv.remove();
      };
    }

    async function saveAvailability() {
      if (!currentUser) {
        setStatus('Please log in first.', true);
        return;
      }

      const timezone = document.getElementById('timezone').value;
      if (!timezone) {
        setStatus('Please select your timezone.', true);
        return;
      }

      // Collect weekly schedule
      const weekDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const weeklySchedule = {};

      weekDays.forEach(day => {
        const slots = [];
        const slotElements = document.querySelectorAll(`#slots-${day} .time-slot`);

        slotElements.forEach(slotEl => {
          const start = slotEl.querySelector('.slot-start').value;
          const end = slotEl.querySelector('.slot-end').value;

          if (start && end && start < end) {
            slots.push({ start, end });
          }
        });

        weeklySchedule[day] = slots;
      });

      try {
        setStatus('Saving availability...', false);

        await setDoc(
          doc(db, 'instructor_availability', currentUser.uid),
          {
            timezone,
            weeklySchedule,
            updatedAt: new Date().toISOString()
          },
          { merge: true }
        );

        setStatus('Availability saved successfully!', false);

      } catch (error) {
        console.error('Error saving availability:', error);
        setStatus('Error saving availability: ' + error.message, true);
      }
    }

    async function loadAvailability() {
      if (!currentUser) return;

      try {
        const docSnap = await getDoc(doc(db, 'instructor_availability', currentUser.uid));

        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('timezone').value = data.timezone || '';

          weeklyScheduleData = data.weeklySchedule || {
            monday: [], tuesday: [], wednesday: [], thursday: [],
            friday: [], saturday: [], sunday: []
          };

          renderWeeklyScheduleGrid();
        }

      } catch (error) {
        console.error('Error loading availability:', error);
      }
    }

    // UNREAD MESSAGE COUNT

    // NOTIFICATION COUNTS (messages + friend requests + new bookings)
    let _unreadMsgCount = 0;
    let _pendingReqCount = 0;
    let _newBookingCount = 0;

    function _updateProfileBadge() {
      const total = _unreadMsgCount + _pendingReqCount + _newBookingCount;
      const badge = document.getElementById('notificationBadge');
      if (badge) {
        if (total > 0) {
          badge.textContent = total > 9 ? '9+' : total;
          badge.classList.add('show');
        } else {
          badge.classList.remove('show');
        }
      }
    }

    async function loadUnreadMessageCount() {
      if (!auth.currentUser) return;

      const q = query(
        collection(db, 'conversations'),
        where('participants', 'array-contains', auth.currentUser.uid)
      );

      onSnapshot(q, (snapshot) => {
        _unreadMsgCount = 0;
        snapshot.forEach((doc) => {
          const conv = doc.data();
          if (conv.unreadCount && conv.unreadCount[auth.currentUser.uid]) {
            _unreadMsgCount += conv.unreadCount[auth.currentUser.uid];
          }
        });

        const messagesLink = document.getElementById('messagesLink');
        const unreadCount  = document.getElementById('unreadCount');

        if (messagesLink) {
          if (_unreadMsgCount > 0) {
            messagesLink.classList.add('has-unread');
          } else {
            messagesLink.classList.remove('has-unread');
          }
        }

        if (unreadCount) {
          if (_unreadMsgCount > 0) {
            unreadCount.textContent = _unreadMsgCount > 99 ? '99+' : _unreadMsgCount;
            unreadCount.classList.add('show');
          } else {
            unreadCount.classList.remove('show');
          }
        }

        _updateProfileBadge();
      });
    }

    function loadPendingRequests() {
      if (!auth.currentUser) return;
      const uid = auth.currentUser.uid;

      function _updateActivityBadge() {
        const total = _pendingReqCount + _newBookingCount;
        const el = document.getElementById('activityCount');
        if (el) {
          if (total > 0) { el.textContent = total; el.classList.add('show'); }
          else { el.classList.remove('show'); }
        }
      }

      onSnapshot(
        query(collection(db, 'friendRequests'), where('toId', '==', uid)),
        (snapshot) => {
          _pendingReqCount = snapshot.docs.filter(d => d.data().status === 'pending').length;
          _updateActivityBadge();
          _updateProfileBadge();
        }
      );

      // New unseen bookings (for instructors)
      onSnapshot(
        query(collection(db, 'bookings'), where('instructorId', '==', uid)),
        (snapshot) => {
          _newBookingCount = snapshot.docs.filter(d => d.data().instructorSeen === false).length;
          _updateActivityBadge();
          _updateProfileBadge();
        }
      );
    }

    // ── Stripe Payment Setup ─────────────────────────────────────

    async function checkStripePaymentStatus(forceCheck = false) {
      try {
        const instructorSnap = await getDoc(doc(db, 'instructors', currentUser.uid));

        if (!instructorSnap.exists() || !instructorSnap.data().stripeAccountId) {
          renderStripeSection('not-connected');
          return;
        }

        const data = instructorSnap.data();

        // On return from Stripe onboarding, or if not yet marked complete, verify with Stripe
        if (forceCheck || data.stripeOnboardingComplete !== true) {
          try {
            const getDashboard = httpsCallable(functions, 'getStripeConnectDashboard');
            const result = await getDashboard();
            const { chargesEnabled } = result.data;

            if (chargesEnabled) {
              await setDoc(doc(db, 'instructors', currentUser.uid),
                { stripeOnboardingComplete: true }, { merge: true });
              renderStripeSection('connected');
            } else {
              renderStripeSection('incomplete');
            }
          } catch (err) {
            console.error('Stripe status check error:', err);
            renderStripeSection(data.stripeOnboardingComplete ? 'connected' : 'incomplete');
          }
          return;
        }

        renderStripeSection('connected');
      } catch (error) {
        console.error('Error checking Stripe status:', error);
        renderStripeSection('not-connected');
      }
    }

    function renderStripeSection(state) {
      const section = document.getElementById('stripe-status-section');

      if (state === 'not-connected') {
        section.innerHTML = `
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
            Connect your Stripe account to receive payments from students.
            Lingua Bud retains a 10% platform fee per lesson.
          </p>
          <button id="connect-stripe-btn" type="button">
            <i class="fas fa-link"></i> Connect with Stripe
          </button>
        `;
        document.getElementById('connect-stripe-btn').onclick = connectStripe;

      } else if (state === 'incomplete') {
        section.innerHTML = `
          <div style="display:flex;align-items:center;gap:0.75rem;padding:1rem;background:#fff3cd;border:1px solid #ffc107;border-radius:8px;margin-bottom:1rem;">
            <i class="fas fa-exclamation-circle" style="color:#f59e0b;font-size:1.25rem;flex-shrink:0;"></i>
            <div>
              <strong>Setup Incomplete</strong>
              <p style="margin:0;font-size:0.875rem;color:#666;">Complete your Stripe account to start receiving payments.</p>
            </div>
          </div>
          <button id="complete-stripe-btn" type="button">
            <i class="fas fa-external-link-alt"></i> Complete Stripe Setup
          </button>
        `;
        document.getElementById('complete-stripe-btn').onclick = continueStripeOnboarding;

      } else if (state === 'connected') {
        section.innerHTML = `
          <div style="display:flex;align-items:center;gap:0.75rem;padding:1rem;background:#d1fae5;border:1px solid #10b981;border-radius:8px;margin-bottom:1rem;">
            <i class="fas fa-check-circle" style="color:#10b981;font-size:1.5rem;flex-shrink:0;"></i>
            <div>
              <strong style="color:#065f46;">Stripe Connected</strong>
              <p style="margin:0;font-size:0.875rem;color:#666;">You are ready to receive lesson payments from students.</p>
            </div>
          </div>
          <button id="view-stripe-btn" type="button">
            <i class="fas fa-external-link-alt"></i> View Stripe Dashboard
          </button>
        `;
        document.getElementById('view-stripe-btn').onclick = openStripeDashboard;
      }
    }

    async function connectStripe() {
      const btn = document.getElementById('connect-stripe-btn');
      if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...'; }
      try {
        const createAccount = httpsCallable(functions, 'createStripeConnectAccount');
        const result = await createAccount();
        window.location.href = result.data.url;
      } catch (error) {
        console.error('Error connecting Stripe:', error);
        setStatus('Error connecting Stripe: ' + error.message, true);
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-link"></i> Connect with Stripe'; }
      }
    }

    async function continueStripeOnboarding() {
      const btn = document.getElementById('complete-stripe-btn');
      if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...'; }
      try {
        // createStripeConnectAccount handles existing accounts — returns a fresh onboarding link
        const createAccount = httpsCallable(functions, 'createStripeConnectAccount');
        const result = await createAccount();
        window.location.href = result.data.url;
      } catch (error) {
        console.error('Error resuming Stripe onboarding:', error);
        setStatus('Error: ' + error.message, true);
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-external-link-alt"></i> Complete Stripe Setup'; }
      }
    }

    async function openStripeDashboard() {
      const btn = document.getElementById('view-stripe-btn');
      if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...'; }
      try {
        const getDashboard = httpsCallable(functions, 'getStripeConnectDashboard');
        const result = await getDashboard();
        if (result.data.loginUrl) {
          window.open(result.data.loginUrl, '_blank');
        } else {
          setStatus('Dashboard link unavailable. Please try again later.', true);
        }
      } catch (error) {
        console.error('Error opening Stripe dashboard:', error);
        setStatus('Error: ' + error.message, true);
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-external-link-alt"></i> View Stripe Dashboard'; }
      }
    }

    // ── Account Deletion ──────────────────────────────────────────
    const delBackdrop = document.getElementById('del-backdrop');
    const delCancel   = document.getElementById('del-cancel');
    const delConfirm  = document.getElementById('del-confirm');
    const delBtnText  = document.getElementById('del-btn-text');
    const delError    = document.getElementById('del-error');

    document.getElementById('open-delete-modal').addEventListener('click', () => {
      delError.style.display = 'none';
      delConfirm.disabled = false;
      delBtnText.textContent = 'Yes, Delete Account';
      delBackdrop.classList.add('active');
    });

    delCancel.addEventListener('click', () => delBackdrop.classList.remove('active'));

    delBackdrop.addEventListener('click', (e) => {
      if (e.target === delBackdrop) delBackdrop.classList.remove('active');
    });

    delConfirm.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;

      delConfirm.disabled = true;
      delBtnText.textContent = 'Deleting…';
      delError.style.display = 'none';

      try {
        await deleteDoc(doc(db, 'instructors', user.uid));
        await deleteUser(user);
        window.location.href = 'index.html';
      } catch (err) {
        delConfirm.disabled = false;
        delBtnText.textContent = 'Yes, Delete Account';
        delError.textContent = err.code === 'auth/requires-recent-login'
          ? 'For security, please sign out and sign back in before deleting your account.'
          : 'Something went wrong. Please try again.';
        delError.style.display = 'block';
      }
    });

  </script>
</body>
</html>