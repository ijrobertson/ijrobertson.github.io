<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instructor Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background-color: #20bcba;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 700px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    .tag {
      background-color: #20bcba;
      color: white;
      border-radius: 15px;
      padding: 0.3rem 0.8rem;
      display: inline-block;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    button {
      background-color: #20bcba;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 0.25rem;
      width: auto;
      min-width: 120px;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #199c9a;
    }
    .secondary {
      background: #c0392b;
    }
    .profile-pic-preview {
      max-width: 150px;
      max-height: 150px;
      margin-bottom: 1rem;
      border-radius: 50%;
    }
    .horizontal-btns {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .status-message {
      text-align: center;
      margin: 1rem 0;
      font-weight: 600;
    }
  </style>
  <script type="module">
    // === UPDATE THESE TWO LINES with your own Supabase project info! ===
    const SUPABASE_URL = "https://fryhforpxlavbpimaljf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyeWhmb3JweGxhdmJwaW1hbGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4ODIwNDEsImV4cCI6MjA2NjQ1ODA0MX0.S5XbzUZeq4lCR2O-_siaSg86b6FQwLxvizF3yVvpidI";
    // === END CONFIG ---

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // -- Languages, Countries, Currencies --
    const languages = [
      "Mandarin Chinese", "Spanish", "English", "Hindi", "Arabic", "Bengali", "Portuguese", "Russian", "Urdu", "Indonesian",
      "German", "French", "Japanese", "Punjabi", "Turkish", "Vietnamese", "Korean", "Italian", "Thai", "Polish",
      "Ukrainian", "Persian", "Dutch", "Romanian", "Czech", "Greek", "Hungarian", "Swedish", "Hebrew", "Danish",
      "Norwegian", "Finnish", "Malayalam", "Telugu", "Tamil", "Marathi", "Swahili", "Javanese", "Burmese", "Serbian",
      "Slovak", "Croatian", "Bulgarian", "Malay", "Filipino", "Amharic", "Zulu", "Kazakh", "Nepali", "Sinhala"
    ];
    const countries = [
      "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
      "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia",
      "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada",
      "Cape Verde", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Brazzaville)", "Congo (Kinshasa)", "Costa Rica",
      "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "East Timor", "Ecuador",
      "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France",
      "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau",
      "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland",
      "Israel", "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait",
      "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
      "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico",
      "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru",
      "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman",
      "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
      "Puerto Rico", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent", "Samoa", "San Marino",
      "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
      "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
      "São Tomé and Príncipe", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey",
      "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu",
      "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
    ];
    const currencies = [
      { code: "USD", name: "US Dollar", symbol: "$" },
      { code: "EUR", name: "Euro", symbol: "€" },
      { code: "GBP", name: "British Pound", symbol: "£" },
      { code: "CAD", name: "Canadian Dollar", symbol: "$" },
      { code: "AUD", name: "Australian Dollar", symbol: "$" },
    ];

    // --- DOM READY ---
    document.addEventListener("DOMContentLoaded", async () => {
      populateSelect('spokenLanguage', languages);
      populateSelect('teachingLanguage', languages);
      populateSelect('country', countries);
      populateCurrency();
      registerEventHandlers();

      // Show the right view based on login
      await showProfileOrAuth();
      supabase.auth.onAuthStateChange(showProfileOrAuth);
    });

    // --- Utility functions ---
    function populateSelect(id, items) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.text = item;
        select.appendChild(option);
      });
    }
    function populateCurrency() {
      const select = document.getElementById("currency");
      select.innerHTML = "";
      currencies.forEach(cur => {
        const option = document.createElement('option');
        option.value = cur.code;
        option.text = `${cur.symbol} ${cur.code}`;
        select.appendChild(option);
      });
    }

    function registerEventHandlers() {
      // Image preview
      document.getElementById('avatar').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.getElementById('avatarPreview');
          img.src = reader.result;
          img.style.display = 'block';
        };
        if (e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
      });
      // Spoken/Teaching language tagging
      document.getElementById('add-spoken-btn').onclick = () => addLanguage('spoken');
      document.getElementById('add-teaching-btn').onclick = () => addLanguage('teaching');
      document.getElementById('save-btn').onclick = saveProfile;
      document.getElementById('logout-btn').onclick = async () => {
        await supabase.auth.signOut();
      };
      // Login/Signup
      document.getElementById('login-btn').onclick = loginHandler;
      document.getElementById('signup-btn').onclick = signupHandler;
    }

    function addLanguage(type) {
      const select = document.getElementById(type + 'Language');
      const value = select.value;
      const container = document.getElementById(type + 'Languages');
      // Prevent duplicates
      if (!value || Array.from(container.children).some(
        (c) => c.textContent === value)
      ) return;
      const span = document.createElement('span');
      span.className = 'tag';
      span.textContent = value;
      span.title = "Click to remove";
      span.onclick = () => span.remove();
      container.appendChild(span);
    }

    // Show/hide auth/profile views
    async function showProfileOrAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      document.getElementById("auth-container").style.display = user ? "none" : "block";
      document.getElementById("profile-container").style.display = user ? "block" : "none";
      document.getElementById("status").textContent = "";
      if (user) {
        // Load profile fields if they exist
        loadProfileFields(user);
      } else {
        // Clear fields for privacy if logged out
        clearProfileFields();
      }
    }

    // Login/signup handlers
    async function loginHandler() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      if (!email || !password) return alert('Enter email and password');
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message);
    }

    async function signupHandler() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      if (!email || !password) return alert('Enter email and password');
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) alert(error.message);
      else alert("Signup complete. Check your email for confirmation link!");
    }

    // Save/load profile functions
    async function saveProfile() {
      setStatus(""); // clear
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        setStatus('Please log in first.', true);
        return;
      }
      // Gather values
      const spoken = [...document.getElementById('spokenLanguages').children].map(c => c.textContent);
      const teaching = [...document.getElementById('teachingLanguages').children].map(c => c.textContent);
      const avatarFile = document.getElementById('avatar').files[0];
      let avatar_url = document.getElementById('avatarPreview').src;
      // Upload avatar if a new one is present and not a data URL
      if (avatarFile && avatar_url.startsWith('data')) {
        const fileExt = avatarFile.name.split('.').pop();
        const filePath = `avatars/${user.id}.${fileExt}`;
        let { error: uploadError } = await supabase.storage.from('avatars').upload(filePath, avatarFile, { upsert: true });
        if (!uploadError) {
          const { data } = supabase.storage.from('avatars').getPublicUrl(filePath);
          avatar_url = data.publicUrl;
        }
      }
      // Save upsert
      const profile = {
        user_id: user.id,
        name: (document.getElementById('name').value || "").trim(),
        languages_spoken: spoken,
        languages_teaching: teaching,
        price_per_lesson: parseFloat(document.getElementById('price').value) || null,
        currency: document.getElementById('currency').value,
        bio: (document.getElementById('bio').value || "").trim(),
        native_country: document.getElementById('country').value,
        avatar_url: avatar_url.startsWith('data:') ? null : avatar_url, // only store real URLs
        email: user.email,
      };
      const { error } = await supabase.from('instructors').upsert(profile, { onConflict: 'user_id' });
      if (error) setStatus("Error saving profile: " + error.message, true);
      else setStatus("Profile saved successfully!", false);
    }
    function setStatus(msg, isError) {
      const el = document.getElementById('status');
      el.textContent = msg || "";
      el.style.color = isError ? "red" : "green";
    }

    async function loadProfileFields(user) {
      setStatus("Loading profile...");
      const { data, error } = await supabase
        .from('instructors')
        .select('*')
        .eq('user_id', user.id)
        .single();
      clearProfileFields();
      if (data) {
        document.getElementById('name').value = data.name || '';
        document.getElementById('price').value = data.price_per_lesson || '';
        document.getElementById('currency').value = data.currency || '';
        document.getElementById('bio').value = data.about_me || '';
        document.getElementById('country').value = data.native_country || '';
        // Avatar:
        if (data.avatar_url) {
          document.getElementById('avatarPreview').src = data.avatar_url;
          document.getElementById('avatarPreview').style.display = 'block';
        } else {
          document.getElementById('avatarPreview').src = "#";
          document.getElementById('avatarPreview').style.display = 'none';
        }
        // Languages:
        const spokenDiv = document.getElementById('spokenLanguages');
        (data.spoken_languages || []).forEach(lang => {
          const span = document.createElement('span');
          span.className = 'tag';
          span.textContent = lang;
          span.title = "Click to remove";
          span.onclick = () => span.remove();
          spokenDiv.appendChild(span);
        });
        const teachingDiv = document.getElementById('teachingLanguages');
        (data.teaching_languages || []).forEach(lang => {
          const span = document.createElement('span');
          span.className = 'tag';
          span.textContent = lang;
          span.title = "Click to remove";
          span.onclick = () => span.remove();
          teachingDiv.appendChild(span);
        });
        setStatus("");
      } else if (error && error.code !== "PGRST116") {
        // Ignore No Rows Found
        setStatus("Error loading profile: " + error.message, true);
      } else {
        setStatus("");
      }
      // Set email in UI?
    }
    function clearProfileFields() {
      ["name", "price", "bio", "avatar"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      document.getElementById('avatarPreview').src = "#";
      document.getElementById('avatarPreview').style.display = 'none';
      document.getElementById('spokenLanguages').innerHTML = "";
      document.getElementById('teachingLanguages').innerHTML = "";
    }
  </script>
</head>
<body>
  <header>
    <h1>Instructor Dashboard</h1>
  </header>
  <!-- AUTH SECTION -->
  <div id="auth-container" class="container" style="max-width:350px">
    <h2>Sign in / Sign up</h2>
    <label for="login-email">Email</label>
    <input id="login-email" type="email" placeholder="Email" autocomplete="username" />
    <label for="login-password">Password</label>
    <input id="login-password" type="password" placeholder="Password" autocomplete="current-password" />
    <div class="horizontal-btns">
      <button id="login-btn">Sign In</button>
      <button id="signup-btn" type="button" style="background:#199c9a;">Sign Up</button>
    </div>
    <div style="margin-top:10px; font-size:90%;">
      First time? Use sign up. After email confirmation, come back to sign in.
    </div>
  </div>
  <!-- PROFILE SECTION -->
  <div class="container" id="profile-container" style="display:none;">
    <label for="name">Full Name</label>
    <input type="text" id="name" />

    <label for="avatar">Profile Picture</label>
    <input type="file" id="avatar" accept="image/*" />
    <img id="avatarPreview" class="profile-pic-preview" src="#" alt="" style="display:none;"/>

    <label for="spokenLanguage">Languages You Speak</label>
    <div class="horizontal-btns" style="gap:0.5rem; align-items: center;">
      <select id="spokenLanguage"></select>
      <button type="button" id="add-spoken-btn">Add</button>
    </div>
    <div id="spokenLanguages"></div>

    <label for="teachingLanguage">Languages You Teach</label>
    <div class="horizontal-btns" style="gap:0.5rem; align-items: center;">
      <select id="teachingLanguage"></select>
      <button type="button" id="add-teaching-btn">Add</button>
    </div>
    <div id="teachingLanguages"></div>

    <label for="price">Price Per Lesson</label>
    <input type="number" id="price" min="0" placeholder="Enter price" />
    <select id="currency"></select>

    <label for="bio">About Me</label>
    <textarea id="bio" rows="5" placeholder="Write a short bio..."></textarea>

    <label for="country">Native Country</label>
    <select id="country"></select>

    <div class="horizontal-btns" style="gap:0.5rem;">
      <button id="save-btn" type="button">Save Profile</button>
      <button id="logout-btn" type="button" class="secondary">Log out</button>
    </div>
    <div id="status" class="status-message"></div>
  </div>
</body>
</html>
