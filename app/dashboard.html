<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instructor Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background-color: #20bcba;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 700px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    .tag {
      background-color: #20bcba;
      color: white;
      border-radius: 15px;
      padding: 0.3rem 0.8rem;
      display: inline-block;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    button {
      background-color: #20bcba;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 0.25rem;
      width: auto;
      min-width: 120px;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #199c9a;
    }
    .secondary {
      background: #c0392b;
    }
    .profile-pic-preview {
      max-width: 150px;
      max-height: 150px;
      margin-bottom: 1rem;
      border-radius: 50%;
    }
    .horizontal-btns {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .status-message {
      text-align: center;
      margin: 1rem 0;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <h1>Instructor Dashboard</h1>
  </header>

  <div class="container" id="profile-container">
    <label for="name">Full Name</label>
    <input type="text" id="name" />

    <label for="avatar">Profile Picture</label>
<input type="file" id="avatar" accept="image/*" />

<img
  id="avatarPreview"
  class="profile-pic-preview"
  style="display:none;"
/>


    <label for="spokenLanguage">Languages You Speak</label>
    <div class="horizontal-btns">
      <select id="spokenLanguage"></select>
      <button type="button" id="add-spoken-btn">Add</button>
    </div>
    <div id="languages_spoken"></div>

    <label for="teachingLanguage">Languages You Teach</label>
    <div class="horizontal-btns">
      <select id="teachingLanguage"></select>
      <button type="button" id="add-teaching-btn">Add</button>
    </div>
    <div id="languages_teaching"></div>

    <label for="price">Price Per Lesson</label>
    <input type="number" id="price" min="0" placeholder="Enter price" />
    <label for="currency">Currency</label>
    <select id="currency"></select>

    <label for="about_me">About Me</label>
    <textarea id="about_me" rows="5" placeholder="Write a short bio..."></textarea>

    <label for="country">Native Country</label>
    <select id="country"></select>

    <div class="horizontal-btns">
      <button id="save-btn" type="button">Save Profile</button>
      <button id="logout-btn" type="button" class="secondary">Log out</button>
    </div>
    <div id="status" class="status-message"></div>
  </div>

  <script type="module">
    import {
      auth,
      db,
      signOut,
      onAuthStateChanged,
      doc,
      getDoc,
      setDoc
    } from '../lib/firebaseClient.js';

    // Language/country/currency data
    const languages = [
      "Mandarin Chinese", "Spanish", "English", "Hindi", "Arabic", "Bengali", "Portuguese", "Russian", "Urdu", "Indonesian",
      "German", "French", "Japanese", "Punjabi", "Turkish", "Vietnamese", "Korean", "Italian", "Thai", "Polish",
      "Ukrainian", "Persian", "Dutch", "Romanian", "Czech", "Greek", "Hungarian", "Swedish", "Hebrew", "Danish",
      "Norwegian", "Finnish", "Malayalam", "Telugu", "Tamil", "Marathi", "Swahili", "Javanese", "Burmese", "Serbian",
      "Slovak", "Croatian", "Bulgarian", "Malay", "Filipino", "Amharic", "Zulu", "Kazakh", "Nepali", "Sinhala"
    ];
    const countries = [
      "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
      "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia",
      "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada",
      "Cape Verde", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Brazzaville)", "Congo (Kinshasa)", "Costa Rica",
      "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "East Timor", "Ecuador",
      "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France",
      "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau",
      "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland",
      "Israel", "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait",
      "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
      "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico",
      "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru",
      "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman",
      "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
      "Puerto Rico", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent", "Samoa", "San Marino",
      "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
      "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
      "São Tomé and Príncipe", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey",
      "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu",
      "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
    ];
    const currencies = [
      { code: "USD", name: "US Dollar", symbol: "$" },
      { code: "EUR", name: "Euro", symbol: "€" },
      { code: "GBP", name: "British Pound", symbol: "£" },
      { code: "CAD", name: "Canadian Dollar", symbol: "$" },
      { code: "AUD", name: "Australian Dollar", symbol: "$" },
    ];

    // Track selected languages
    let spokenLanguages = [];
    let teachingLanguages = [];
    let currentUser = null;

    document.addEventListener("DOMContentLoaded", async () => {
      populateSelect('spokenLanguage', languages);
      populateSelect('teachingLanguage', languages);
      populateSelect('country', countries);
      populateCurrency();

      document.getElementById('add-spoken-btn').onclick = () => addLanguage('spoken');
      document.getElementById('add-teaching-btn').onclick = () => addLanguage('teaching');
      document.getElementById('save-btn').onclick = saveProfile;
      document.getElementById('logout-btn').onclick = async () => {
        await signOut(auth);
        window.location.href = "../login.html";
      };

      // Avatar URL preview
      document.getElementById('avatar_url').addEventListener('input', (e) => {
        const url = e.target.value.trim();
        const img = document.getElementById('avatarPreview');
        if (url) {
          img.src = url;
          img.style.display = 'block';
          img.onerror = () => { img.style.display = 'none'; };
        } else {
          img.style.display = 'none';
        }
      });

      // Listen for auth state
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          await loadProfile();
        } else {
          setStatus("Not logged in!", true);
          window.location.href = "../login.html";
        }
      });
    });

    function populateSelect(id, items) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.text = item;
        select.appendChild(option);
      });
    }

    function populateCurrency() {
      const select = document.getElementById("currency");
      select.innerHTML = "";
      currencies.forEach(cur => {
        const option = document.createElement('option');
        option.value = cur.code;
        option.text = `${cur.symbol} ${cur.code}`;
        select.appendChild(option);
      });
    }

    function addLanguage(type) {
      const select = document.getElementById(type === 'spoken' ? 'spokenLanguage' : 'teachingLanguage');
      const value = select.value;
      const list = type === 'spoken' ? spokenLanguages : teachingLanguages;
      if (!value || list.includes(value)) return;
      list.push(value);
      renderLanguages();
    }

    function renderLanguages() {
      const spokenDiv = document.getElementById('languages_spoken');
      spokenDiv.innerHTML = "";
      spokenLanguages.forEach(lang => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = lang;
        span.title = "Click to remove";
        span.onclick = function() {
          spokenLanguages = spokenLanguages.filter(l => l !== lang);
          renderLanguages();
        };
        spokenDiv.appendChild(span);
      });

      const teachingDiv = document.getElementById('languages_teaching');
      teachingDiv.innerHTML = "";
      teachingLanguages.forEach(lang => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = lang;
        span.title = "Click to remove";
        span.onclick = function() {
          teachingLanguages = teachingLanguages.filter(l => l !== lang);
          renderLanguages();
        };
        teachingDiv.appendChild(span);
      });
    }

    function setStatus(msg, isError) {
      const el = document.getElementById('status');
      el.textContent = msg || "";
      el.style.color = isError ? "red" : "green";
    }

    async function saveProfile() {
      setStatus("");
      if (!currentUser) {
        setStatus('Please log in first.', true);
        return;
      }

      const profile = {
        name: (document.getElementById('name').value || "").trim(),
        languages_spoken: spokenLanguages,
        languages_teaching: teachingLanguages,
        price_per_lesson: parseFloat(document.getElementById('price').value) || null,
        currency: document.getElementById('currency').value,
        about_me: (document.getElementById('about_me').value || "").trim(),
        native_country: document.getElementById('country').value,
        avatar_url: (document.getElementById('avatar_url').value || "").trim(),
        email: currentUser.email,
        updatedAt: new Date().toISOString()
      };

      try {
        await setDoc(doc(db, 'instructors', currentUser.uid), profile);
        setStatus("Profile saved successfully!", false);
      } catch (error) {
        setStatus("Error saving profile: " + error.message, true);
      }
    }

    async function loadProfile() {
      setStatus("Loading profile...");

      try {
        const docSnap = await getDoc(doc(db, 'instructors', currentUser.uid));

        // Clear fields first
        document.getElementById('name').value = "";
        document.getElementById('price').value = "";
        document.getElementById('currency').value = "USD";
        document.getElementById('about_me').value = "";
        document.getElementById('country').value = "";
        document.getElementById('avatar_url').value = "";
        spokenLanguages = [];
        teachingLanguages = [];
        document.getElementById('avatarPreview').src = "#";
        document.getElementById('avatarPreview').style.display = 'none';

        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('name').value = data.name || "";
          document.getElementById('price').value = data.price_per_lesson || "";
          document.getElementById('currency').value = data.currency || "USD";
          document.getElementById('about_me').value = data.about_me || "";
          document.getElementById('country').value = data.native_country || "";
          document.getElementById('avatar_url').value = data.avatar_url || "";

          spokenLanguages = Array.isArray(data.languages_spoken) ? data.languages_spoken : [];
          teachingLanguages = Array.isArray(data.languages_teaching) ? data.languages_teaching : [];
          renderLanguages();

          if (data.avatar_url) {
            document.getElementById('avatarPreview').src = data.avatar_url;
            document.getElementById('avatarPreview').style.display = 'block';
          }
        }
        setStatus("");
      } catch (error) {
        setStatus("Error loading profile: " + error.message, true);
      }
    }
  </script>

<script type="module">
  // 1️⃣ Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
  import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 2️⃣ Your Firebase config (COPY from your login page)
  const firebaseConfig = {
  apiKey: "AIzaSyCQkMgY7a6t-qEcBiAO2tAhsdwbEIy9KKI",
  authDomain: "linguabud-9a942.firebaseapp.com",
  projectId: "linguabud-9a942",
  storageBucket: "linguabud-9a942.firebasestorage.app",
  messagingSenderId: "752734519356",
  appId: "1:752734519356:web:d85200d4c3dd6728e44339",
  measurementId: "G-2BEQ0MFFR6"
};

  // 3️⃣ Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const db = getFirestore(app);

  // 4️⃣ Track logged-in user
 let currentUser = null;
let authReady = false;

onAuthStateChanged(auth, (user) => {
  authReady = true;

  if (user) {
    currentUser = user;
    console.log("User authenticated:", user.uid);
  } else {
    console.log("No user session");
    window.location.href = "login.html";
  }
});


    const avatarInput = document.getElementById("avatar");
  const avatarPreview = document.getElementById("avatarPreview");

  avatarInput.addEventListener("change", async (e) => {
  if (!authReady) return; // wait for Firebase
  if (!currentUser) return;

  const file = e.target.files[0];
  if (!file) return;

  try {
    const avatarRef = ref(storage, `avatars/${currentUser.uid}`);
    await uploadBytes(avatarRef, file);
    const downloadURL = await getDownloadURL(avatarRef);

    await updateDoc(doc(db, "users", currentUser.uid), {
      avatar_url: downloadURL
    });

    avatarPreview.src = downloadURL;
    avatarPreview.style.display = "block";

  } catch (err) {
    console.error(err);
    alert("Upload failed");
  }
});


    const file = e.target.files[0];
    if (!file) return;

    try {
      const fileExt = file.name.split('.').pop();
      const avatarRef = ref(storage, `avatars/${currentUser.uid}`);


      // Upload to Firebase Storage
      await uploadBytes(avatarRef, file);

      // Get image URL
      const downloadURL = await getDownloadURL(avatarRef);

      // Save URL to Firestore
      await updateDoc(
        doc(db, "users", currentUser.uid),
        { avatar_url: downloadURL }
      );

      // Show preview
      avatarPreview.src = downloadURL;
      avatarPreview.style.display = "block";

      alert("Profile picture updated!");
    } catch (err) {
      console.error(err);
      alert("Image upload failed");
    }
  });
</script>

  
</body>
</html>
