<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Dashboard - Lingua Bud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Styles -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:500,700&display=swap&subset=latin-ext" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600&display=swap&subset=latin-ext" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet">
  <link href="css/bootstrap.css" rel="stylesheet">
  <link href="css/fontawesome-all.css" rel="stylesheet">
  <link href="css/swiper.css" rel="stylesheet">
  <link href="css/magnific-popup.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">

  <!-- Favicon  -->
  <link rel="icon" href="images/NuevoFavicon.png">

  <style>
    :root {
      --primary: #20bcba;
      --white: #ffffff;
      --light-grey: #f5f5f5;
      --dark-grey: #333333;
      --navy: #1a2a4f;
      --radius: 10px;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--light-grey);
      color: #222;
      padding-top: 4.5rem;
    }

    /* Navbar styles */
    .navbar-custom {
      background-color: #113448 !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .profile-nav-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-left: 1rem;
    }

    .profile-pic-nav {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #20bcba;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .profile-pic-nav:hover {
      transform: scale(1.1);
    }

    .profile-dropdown {
      position: relative;
      display: inline-block;
    }

    .profile-dropdown-content {
      position: fixed;
      right: 1rem;
      top: 60px;
      background-color: white;
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
      transition-delay: 0s;
    }

    /* Desktop: position relative to parent */
    @media (min-width: 992px) {
      .profile-dropdown-content {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.25rem;
      }
    }

    .profile-dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background 0.2s;
    }

    .profile-dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .profile-dropdown-content a.messages-link i {
      transition: color 0.2s;
    }

    .profile-dropdown-content a.messages-link.has-unread i {
      color: #dc3545;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Notification badge on profile picture */
    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background-color: #dc3545;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      border: 2px solid white;
      animation: badgePulse 2s infinite;
    }

    .notification-badge.show {
      display: flex;
    }

    @keyframes badgePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Unread count badge in dropdown */
    .unread-count {
      display: none;
      background-color: #dc3545;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 8px;
      min-width: 18px;
      text-align: center;
    }

    .unread-count.show {
      display: inline-block;
    }

    .profile-dropdown:hover .profile-dropdown-content {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      transition-delay: 0s;
    }

    .profile-dropdown-content:hover {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* Mobile support - show dropdown when clicked */
    .profile-dropdown-content.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .page {
      max-width: 900px;
      margin: 1.5rem auto 3rem;
      padding: 0 1rem;
    }
    .profile-card {
      background: white;
      border-radius: var(--radius);
      padding: 1.5rem 1.5rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      position: relative;
    }
    .profile-left, .profile-right {
      flex: 1 1 300px;
      min-width: 280px;
    }
    .section-title {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--navy);
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 1rem;
      margin-bottom: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d3d3d3;
      border-radius: 6px;
      font-size: 1rem;
      resize: vertical;
    }
    textarea {
      min-height: 100px;
    }
    .save-btn {
      margin-top: 1rem;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    .save-btn:hover {
      background: #199c9a;
    }
    .small-note {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
    }
    .status {
      margin-top: 10px;
      font-weight: 600;
    }
    .profile-picture-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .avatar-container {
      position: relative;
      display: inline-block;
    }
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      background-color: #f0f0f0;
    }
    .avatar-edit-btn {
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 32px;
      height: 32px;
      padding: 0;
      margin: 0;
      border-radius: 50%;
      background: var(--primary);
      border: 2px solid white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .avatar-edit-btn:hover {
      background: #199c9a;
    }
    .avatar-edit-btn svg {
      width: 14px;
      height: 14px;
      fill: white;
    }
    #avatar {
      display: none;
    }
    .tag {
      background-color: var(--primary);
      color: white;
      border-radius: 15px;
      padding: 0.4rem 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    .tag .remove-tag {
      cursor: pointer;
      font-weight: bold;
      padding: 0 0.3rem;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      line-height: 1;
    }
    .tag .remove-tag:hover {
      background: rgba(255,255,255,0.5);
    }
    @media (max-width: 800px) {
      .profile-card {
        flex-direction: column;
      }
    }

    /* Booking Card Styles */
    .booking-card {
      background: #f8f9fa;
      padding: 1.25rem;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 1rem;
    }

    .booking-info h5 {
      margin: 0 0 0.5rem 0;
      color: #333;
      font-size: 1.1rem;
    }

    .booking-detail {
      color: #666;
      font-size: 0.95rem;
      margin: 0.25rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .cancel-booking-btn {
      padding: 0.6rem 1.2rem;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s;
    }

    .cancel-booking-btn:hover {
      background: #c82333;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark navbar-custom fixed-top">
    <a class="navbar-brand logo-image" href="index.html"><img src="images/NewLogo8.png" alt="Lingua Bud"></a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-awesome fas fa-bars"></span>
      <span class="navbar-toggler-awesome fas fa-times"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link page-scroll" href="index.html#header">HOME</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="index.html#intro">ABOUT</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="index.html#services">SERVICES</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="Resources2.html">RESOURCES</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="instructors.html">INSTRUCTORS</a>
        </li>
        <li class="nav-item">
          <a class="nav-link page-scroll" href="connect.html">CONNECT</a>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle page-scroll" href="#" id="navbarDropdown" role="button" aria-haspopup="true" aria-expanded="false">LANGUAGES</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="EnglishPage.html"><span class="item-text">ENGLISH</span></a>
            <div class="dropdown-items-divide-hr"></div>
            <a class="dropdown-item" href="NewSpanishPage.html"><span class="item-text">SPANISH</span></a>
            <div class="dropdown-items-divide-hr"></div>
            <a class="dropdown-item" href="NewFrenchPage.html"><span class="item-text">FRENCH</span></a>
            <div class="dropdown-items-divide-hr"></div>
            <a class="dropdown-item" href="NewPortuguesePage.html"><span class="item-text">PORTUGUESE</span></a>
            <div class="dropdown-items-divide-hr"></div>
            <a class="dropdown-item" href="NewItalianPage.html"><span class="item-text">ITALIAN</span></a>
            <div class="dropdown-items-divide-hr"></div>
            <a class="dropdown-item" href="GermanPage.html"><span class="item-text">GERMAN</span></a>
            <div class="dropdown-items-divide-hr"></div>
            <a class="dropdown-item" href="RussianPage.html"><span class="item-text">RUSSIAN</span></a>
            <div class="dropdown-items-divide-hr"></div>
            <a class="dropdown-item" href="SwedishPage.html"><span class="item-text">SWEDISH</span></a>
          </div>
        </li>

        <li class="nav-item">
          <a class="nav-link page-scroll" href="index.html#contact">CONTACT</a>
        </li>
      </ul>

      <!-- Profile Picture Dropdown -->
      <div class="profile-nav-wrapper" id="profileNavWrapper">
        <div class="profile-dropdown">
          <img id="navProfilePic" class="profile-pic-nav" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E" alt="Profile">
          <div class="notification-badge" id="notificationBadge"></div>
          <div class="profile-dropdown-content">
            <a href="student-dashboard.html"><i class="fas fa-user"></i> My Profile</a>
            <a href="messages.html" class="messages-link" id="messagesLink"><i class="fas fa-envelope"></i> Messages<span class="unread-count" id="unreadCount">0</span></a>
            <a href="connect.html"><i class="fas fa-users"></i> Find Partners</a>
            <a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <!-- end of navbar -->

  <div class="page">
    <div class="profile-card">
      <!-- Left / editable fields -->
      <div class="profile-left">
        <div class="section-title">Your Profile</div>

        <label for="name">Full Name</label>
        <input id="name" type="text" placeholder="Your full name" />

        <label for="native_country">Native Country</label>
        <select id="native_country">
          <!-- populated dynamically -->
        </select>

        <label for="spokenLanguage">Languages I Speak</label>
        <select id="spokenLanguage" style="margin-bottom: 0.5rem;"></select>
        <div id="languages_spoken" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;"></div>

        <label for="learningLanguage">Languages I'm Learning</label>
        <select id="learningLanguage" style="margin-bottom: 0.5rem;"></select>
        <div id="languages_learning" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;"></div>

        <label for="about_me">About Me</label>
        <textarea id="about_me" placeholder="Tell us a bit about yourself"></textarea>

        <button class="save-btn" id="save-profile">Save Profile</button>
        <div class="status" id="status-msg"></div>
      </div>

      <!-- Right / avatar -->
      <div class="profile-right">
        <div class="section-title">Profile Picture</div>
        <div class="profile-picture-wrapper">
          <div class="avatar-container">
            <img id="avatarPreview" class="avatar-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E" alt="Avatar" />
            <button type="button" class="avatar-edit-btn" id="avatar-edit-btn" title="Change photo">
              <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
            <input type="file" id="avatar" accept="image/*" />
          </div>
          <div class="small-note">Click the pencil to change your photo.</div>
        </div>
      </div>
    </div>

    <!-- Upcoming Lessons Section -->
    <div class="profile-card" style="margin-top: 2rem;">
      <h3 style="color: var(--primary); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-calendar-check"></i> My Upcoming Lessons
      </h3>
      <div id="student-bookings" style="min-height: 100px;">
        <p style="text-align: center; color: #999;">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/jquery.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.easing.min.js"></script>
  <script src="js/swiper.min.js"></script>
  <script src="js/jquery.magnific-popup.js"></script>
  <script src="js/morphext.min.js"></script>
  <script src="js/isotope.pkgd.min.js"></script>
  <script src="js/validator.min.js"></script>
  <script src="js/scripts.js"></script>

  <script type="module">
    import {
      auth,
      db,
      storage,
      signOut,
      onAuthStateChanged,
      doc,
      getDoc,
      setDoc,
      collection,
      getDocs,
      query,
      where,
      updateDoc,
      onSnapshot,
      ref,
      uploadBytes,
      getDownloadURL
    } from './lib/firebaseClient.js';

    const countries = [
      "Afghanistan","Albania","Algeria","Andorra","Angola","Argentina","Armenia","Australia","Austria","Azerbaijan",
      "Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia",
      "Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cambodia","Cameroon","Canada",
      "Cape Verde","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo (Brazzaville)","Congo (Kinshasa)","Costa Rica",
      "Croatia","Cuba","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","East Timor","Ecuador",
      "Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France",
      "Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau",
      "Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland",
      "Israel","Italy","Ivory Coast","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kuwait",
      "Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg",
      "Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico",
      "Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar","Namibia","Nauru",
      "Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Korea","North Macedonia","Norway","Oman",
      "Pakistan","Palau","Palestine","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal",
      "Puerto Rico","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia","Saint Vincent","Samoa","San Marino",
      "Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia",
      "South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria",
      "S√£o Tom√© and Pr√≠ncipe","Taiwan","Tajikistan","Tanzania","Thailand","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey",
      "Turkmenistan","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan","Vanuatu",
      "Vatican City","Venezuela","Vietnam","Yemen","Zambia","Zimbabwe"
    ];

    const languages = [
      "Mandarin Chinese", "Spanish", "English", "Hindi", "Arabic", "Bengali", "Portuguese", "Russian", "Urdu", "Indonesian",
      "German", "French", "Japanese", "Punjabi", "Turkish", "Vietnamese", "Korean", "Italian", "Thai", "Polish",
      "Ukrainian", "Persian", "Dutch", "Romanian", "Czech", "Greek", "Hungarian", "Swedish", "Hebrew", "Danish",
      "Norwegian", "Finnish", "Malayalam", "Telugu", "Tamil", "Marathi", "Swahili", "Javanese", "Burmese", "Serbian",
      "Slovak", "Croatian", "Bulgarian", "Malay", "Filipino", "Amharic", "Zulu", "Kazakh", "Nepali", "Sinhala"
    ];

    // Default avatar placeholder (inline SVG)
    const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3E%3Ccircle cx='12' cy='8' r='4'/%3E%3Cpath d='M12 14c-6 0-8 3-8 4v2h16v-2c0-1-2-4-8-4z'/%3E%3C/svg%3E";

    let currentUser = null;
    let spokenLanguages = [];
    let learningLanguages = [];

    // Utility to populate country select
    function populateCountries() {
      console.log('üåç Populating countries dropdown...');
      const sel = document.getElementById('native_country');
      if (!sel) {
        console.error('‚ùå Country select element not found!');
        return;
      }
      sel.innerHTML = '';
      countries.forEach(c => {
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        sel.appendChild(o);
      });
      console.log(`‚úÖ Populated ${countries.length} countries`);
    }

    // Populate language selects
    function populateLanguages() {
      console.log('üó£Ô∏è Populating language dropdowns...');
      const spokenSel = document.getElementById('spokenLanguage');
      const learningSel = document.getElementById('learningLanguage');

      if (!spokenSel || !learningSel) {
        console.error('‚ùå Language select elements not found!');
        return;
      }

      spokenSel.innerHTML = '';
      learningSel.innerHTML = '';

      languages.forEach(lang => {
        const o1 = document.createElement('option');
        o1.value = lang;
        o1.textContent = lang;
        spokenSel.appendChild(o1);

        const o2 = document.createElement('option');
        o2.value = lang;
        o2.textContent = lang;
        learningSel.appendChild(o2);
      });
      console.log(`‚úÖ Populated ${languages.length} languages`);
    }

    // Add language to array and render
    function addLanguage(type) {
      const selectId = type === 'spoken' ? 'spokenLanguage' : 'learningLanguage';
      const selectEl = document.getElementById(selectId);
      const lang = selectEl.value;

      if (!lang) return;

      const arr = type === 'spoken' ? spokenLanguages : learningLanguages;

      if (!arr.includes(lang)) {
        arr.push(lang);
        renderLanguages(type);
        // Reset dropdown to empty/default
        selectEl.value = '';
      }
    }

    // Remove language
    function removeLanguage(type, lang) {
      if (type === 'spoken') {
        spokenLanguages = spokenLanguages.filter(l => l !== lang);
      } else {
        learningLanguages = learningLanguages.filter(l => l !== lang);
      }
      renderLanguages(type);
    }

    // Render language tags
    function renderLanguages(type) {
      const containerId = type === 'spoken' ? 'languages_spoken' : 'languages_learning';
      const container = document.getElementById(containerId);
      const arr = type === 'spoken' ? spokenLanguages : learningLanguages;

      container.innerHTML = '';
      arr.forEach(lang => {
        const tag = document.createElement('div');
        tag.className = 'tag';

        const langSpan = document.createElement('span');
        langSpan.textContent = lang;

        const removeSpan = document.createElement('span');
        removeSpan.className = 'remove-tag';
        removeSpan.textContent = '√ó';
        removeSpan.style.cursor = 'pointer';
        removeSpan.addEventListener('click', () => removeLanguage(type, lang));

        tag.appendChild(langSpan);
        tag.appendChild(removeSpan);
        container.appendChild(tag);
      });
    }

    // Track if this is a new user (first time saving)
    let isNewUser = false;

    // Load user profile
    async function loadProfile() {
      console.log('üìÇ Loading profile for user:', currentUser.uid);
      try {
        const docSnap = await getDoc(doc(db, 'users', currentUser.uid));
        console.log('üìÑ Document exists:', docSnap.exists());

        if (docSnap.exists()) {
          const profile = docSnap.data();
          console.log('‚úÖ Profile data loaded:', profile);

          // Check role
          if (profile.role !== 'student') {
            window.location.href = 'dashboard.html';
            return;
          }

          // Populate UI
          document.getElementById('name').value = profile.name || '';
          document.getElementById('about_me').value = profile.about_me || '';
          if (profile.native_country) {
            document.getElementById('native_country').value = profile.native_country;
          }

          // Load languages
          spokenLanguages = profile.languages_spoken || [];
          learningLanguages = profile.languages_learning || [];
          renderLanguages('spoken');
          renderLanguages('learning');

          // Avatar display
          if (profile.avatar_url) {
            document.getElementById('avatarPreview').src = profile.avatar_url;
            document.getElementById('navProfilePic').src = profile.avatar_url;
            localStorage.setItem('student_avatar', profile.avatar_url);
          }

          // Not a new user if profile exists
          isNewUser = false;
        } else {
          // This is a new user (no profile document exists yet)
          console.log('‚ÑπÔ∏è No existing profile found - new user');
          isNewUser = true;
        }
      } catch (error) {
        console.error('‚ùå Error loading profile:', error);
        document.getElementById('status-msg').textContent = 'Error loading profile: ' + error.message;
        document.getElementById('status-msg').style.color = 'red';
      }
    }

    // Make functions globally accessible for inline onclick
    window.removeLanguage = removeLanguage;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ DOM Content Loaded - Initializing student dashboard');

      // Load cached avatar immediately
      const cachedAvatar = localStorage.getItem('student_avatar');
      if (cachedAvatar) {
        document.getElementById('avatarPreview').src = cachedAvatar;
        document.getElementById('navProfilePic').src = cachedAvatar;
      }

      console.log('üìã Populating countries and languages...');
      populateCountries();
      populateLanguages();
      console.log('‚úÖ Dropdowns populated');

      // Add event listeners for language dropdowns (auto-add on selection)
      document.getElementById('spokenLanguage').addEventListener('change', () => addLanguage('spoken'));
      document.getElementById('learningLanguage').addEventListener('change', () => addLanguage('learning'));

      // Avatar edit button triggers file input
      document.getElementById('avatar-edit-btn').onclick = () => {
        document.getElementById('avatar').click();
      };

      // Avatar file upload
      document.getElementById('avatar').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUser) return;

        const statusEl = document.getElementById('status-msg');
        statusEl.textContent = 'Uploading photo...';
        statusEl.style.color = '#666';

        try {
          const avatarRef = ref(storage, `avatars/${currentUser.uid}`);
          await uploadBytes(avatarRef, file);
          const downloadURL = await getDownloadURL(avatarRef);

          await setDoc(doc(db, 'users', currentUser.uid),
            { avatar_url: downloadURL }, { merge: true });

          document.getElementById('avatarPreview').src = downloadURL;
          document.getElementById('navProfilePic').src = downloadURL;
          localStorage.setItem('student_avatar', downloadURL);
          statusEl.textContent = 'Photo uploaded!';
          statusEl.style.color = 'green';
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Photo upload failed: ' + err.message;
          statusEl.style.color = 'red';
        }
      });

      // Listen for auth state
      onAuthStateChanged(auth, async (user) => {
        console.log('üîê Auth state changed:', user ? 'Logged in' : 'Not logged in');
        if (user) {
          currentUser = user;
          console.log('üë§ User ID:', user.uid);
          console.log('üìß User email:', user.email);

          try {
            await loadProfile();
            console.log('‚úÖ Profile loaded successfully');
          } catch (error) {
            console.error('‚ùå Error in loadProfile:', error);
          }

          try {
            await loadStudentBookings();
            console.log('‚úÖ Bookings loaded successfully');
          } catch (error) {
            console.error('‚ùå Error in loadStudentBookings:', error);
          }

          // Load unread message count
          try {
            await loadUnreadMessageCount();
          } catch (error) {
            console.error('‚ùå Error loading unread messages:', error);
          }
        } else {
          console.log('üö´ No user, redirecting to login');
          window.location.href = 'login.html';
        }
      });
    });

    // Save profile
    document.getElementById('save-profile').addEventListener('click', async () => {
      console.log('üíæ Save button clicked');

      if (!currentUser) {
        console.log('‚ùå No current user, redirecting to login');
        window.location.href = 'login.html';
        return;
      }

      const statusEl = document.getElementById('status-msg');
      statusEl.textContent = 'Saving...';
      statusEl.style.color = '#666';

      const updates = {
        name: document.getElementById('name').value.trim(),
        native_country: document.getElementById('native_country').value,
        country: document.getElementById('native_country').value,
        about_me: document.getElementById('about_me').value.trim(),
        languages_spoken: spokenLanguages,
        languages_learning: learningLanguages,
        role: 'student',
        email: currentUser.email,
        updatedAt: new Date().toISOString()
      };

      console.log('üìù Saving profile data:', updates);

      try {
        await setDoc(doc(db, 'users', currentUser.uid), updates, { merge: true });
        console.log('‚úÖ Profile saved successfully!');
        statusEl.textContent = 'Saved! Redirecting to Connect page...';
        statusEl.style.color = 'green';

        // Redirect to Connect page after saving
        setTimeout(() => {
          window.location.href = 'connect.html';
        }, 1500);
      } catch (error) {
        console.error('‚ùå Error saving profile:', error);
        statusEl.textContent = 'Error saving profile: ' + error.message;
        statusEl.style.color = 'red';
      }
    });

    // Logout from navbar
    const logoutLink = document.getElementById('logoutLink');
    if (logoutLink) {
      logoutLink.addEventListener('click', async (e) => {
        e.preventDefault();
        await signOut(auth);
        window.location.href = 'login.html';
      });
    }

    // Mobile dropdown toggle functionality
    const navProfilePic = document.getElementById('navProfilePic');
    const profileDropdown = document.querySelector('.profile-dropdown');
    const profileDropdownContent = document.querySelector('.profile-dropdown-content');

    if (navProfilePic && profileDropdownContent) {
      // Toggle dropdown on click (for mobile)
      navProfilePic.addEventListener('click', (e) => {
        e.stopPropagation();
        profileDropdownContent.classList.toggle('show');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!profileDropdown.contains(e.target)) {
          profileDropdownContent.classList.remove('show');
        }
      });

      // Close dropdown when a link is clicked
      const dropdownLinks = profileDropdownContent.querySelectorAll('a');
      dropdownLinks.forEach(link => {
        link.addEventListener('click', () => {
          profileDropdownContent.classList.remove('show');
        });
      });
    }

    // BOOKING MANAGEMENT FUNCTIONS

    async function loadStudentBookings() {
      console.log('üìÖ Loading student bookings...');
      if (!auth.currentUser) {
        console.log('‚ö†Ô∏è No current user, skipping bookings load');
        return;
      }

      const container = document.getElementById('student-bookings');

      try {
        const now = new Date();
        console.log('üîç Querying bookings for student:', auth.currentUser.uid);

        const q = query(
          collection(db, 'bookings'),
          where('studentId', '==', auth.currentUser.uid),
          where('status', '==', 'confirmed')
        );

        const querySnapshot = await getDocs(q);
        console.log(`üìä Found ${querySnapshot.docs.length} total bookings`);

        // Filter for future bookings and sort
        const futureBookings = querySnapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data(), dateTime: doc.data().dateTime.toDate() }))
          .filter(b => b.dateTime >= now)
          .sort((a, b) => a.dateTime - b.dateTime);

        console.log(`üìÖ ${futureBookings.length} upcoming bookings`);

        if (futureBookings.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666;">No upcoming lessons booked.</p><p style="text-align: center; color: #999; font-size: 0.9rem;">Browse <a href="instructors.html">instructors</a> to book your first lesson!</p>';
          return;
        }

        container.innerHTML = '';
        futureBookings.forEach(booking => {
          container.appendChild(createBookingCard(booking));
        });

      } catch (error) {
        console.error('‚ùå Error loading bookings:', error);
        container.innerHTML = '<p style="color: #dc3545;">Error loading bookings: ' + error.message + '</p>';
      }
    }

    function createBookingCard(booking) {
      const card = document.createElement('div');
      card.className = 'booking-card';

      const dateTime = booking.dateTime;
      const studentTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;

      card.innerHTML = `
        <div class="booking-info">
          <h5>${escapeHtml(booking.instructorName)}</h5>
          <div class="booking-detail">
            <i class="fas fa-calendar"></i>
            ${dateTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
          </div>
          <div class="booking-detail">
            <i class="fas fa-clock"></i>
            ${dateTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
            <span style="color: #999; font-size: 0.85rem;">(${studentTZ})</span>
          </div>
          <div class="booking-detail" style="color: var(--primary);">
            <i class="fas fa-hourglass-half"></i>
            60 minutes
          </div>
        </div>
        <button class="cancel-booking-btn" data-booking-id="${booking.id}">
          <i class="fas fa-times"></i> Cancel
        </button>
      `;

      card.querySelector('.cancel-booking-btn').addEventListener('click', () => {
        cancelBooking(booking.id);
      });

      return card;
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function cancelBooking(bookingId) {
      if (!confirm('Are you sure you want to cancel this lesson?')) return;

      try {
        await updateDoc(doc(db, 'bookings', bookingId), {
          status: 'cancelled',
          cancelledAt: new Date()
        });

        alert('Lesson cancelled successfully.');
        loadStudentBookings(); // Refresh

      } catch (error) {
        console.error('Error cancelling:', error);
        alert('Error cancelling lesson. Please try again.');
      }
    }

    // UNREAD MESSAGE COUNT

    async function loadUnreadMessageCount() {
      if (!auth.currentUser) return;

      const q = query(
        collection(db, 'conversations'),
        where('participants', 'array-contains', auth.currentUser.uid)
      );

      onSnapshot(q, (snapshot) => {
        let totalUnread = 0;

        snapshot.forEach((doc) => {
          const conv = doc.data();
          if (conv.unreadCount && conv.unreadCount[auth.currentUser.uid]) {
            totalUnread += conv.unreadCount[auth.currentUser.uid];
          }
        });

        const messagesLink = document.getElementById('messagesLink');
        const unreadCount = document.getElementById('unreadCount');
        const notificationBadge = document.getElementById('notificationBadge');

        if (messagesLink) {
          if (totalUnread > 0) {
            messagesLink.classList.add('has-unread');
          } else {
            messagesLink.classList.remove('has-unread');
          }
        }

        if (unreadCount) {
          if (totalUnread > 0) {
            unreadCount.textContent = totalUnread > 99 ? '99+' : totalUnread;
            unreadCount.classList.add('show');
          } else {
            unreadCount.classList.remove('show');
          }
        }

        if (notificationBadge) {
          if (totalUnread > 0) {
            notificationBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
            notificationBadge.classList.add('show');
          } else {
            notificationBadge.classList.remove('show');
          }
        }
      });
    }

  </script>
</body>
</html>
